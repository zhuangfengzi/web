<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>阿里云RTC视频聊天</title>
    <link rel="preload" href="https://g.alicdn.com/dingding/dingrtc-sdk/3.6.0/aliyun-webrtc-sdk.js" as="script">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'PingFang SC', sans-serif;
            background: linear-gradient(135deg, #1A1A2E 0%, #16213E 100%);
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
            color: white;
        }
        .container { flex: 1; position: relative; }
        
        /* 状态栏 */
        .status-bar {
            position: absolute; top: 0; left: 0; right: 0; padding: 20px;
            background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, transparent 100%);
            z-index: 1000; display: flex; justify-content: space-between; align-items: center;
        }
        .room-info { display: flex; flex-direction: column; }
        .room-id { font-size: 14px; opacity: 0.8; }
        .connection-status { font-size: 16px; font-weight: bold; }
        
        /* 视频区域 */
        .video-container { 
            width: 100%; height: 100%; position: relative; background: #000;
            display: flex; align-items: center; justify-content: center;
        }
        .remote-video { width: 100%; height: 100%; object-fit: cover; }
        .local-video {
            position: absolute; top: 80px; right: 20px; width: 120px; height: 160px;
            border: 2px solid rgba(255,255,255,0.3); border-radius: 12px; object-fit: cover;
            background: #333;
        }
        
        /* 音频模式 */
        .audio-mode {
            flex: 1; display: flex; flex-direction: column; align-items: center;
            justify-content: center; text-align: center; padding: 40px;
        }
        .avatar {
            width: 200px; height: 200px; border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex; align-items: center; justify-content: center; margin-bottom: 20px;
        }
        .avatar-icon { font-size: 80px; }
        
        /* 控制按钮 */
        .controls {
            position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 20px; padding: 20px; background: rgba(0,0,0,0.4);
            border-radius: 50px; backdrop-filter: blur(20px);
        }
        .control-btn {
            width: 56px; height: 56px; border: none; border-radius: 50%;
            background: rgba(255,255,255,0.15); color: white; font-size: 24px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: all 0.3s ease;
        }
        .control-btn:hover { background: rgba(255,255,255,0.25); }
        .control-btn.active { background: #4CAF50; }
        .control-btn.muted { background: #e74c3c; }
        .control-btn.hangup { background: #e74c3c; width: 64px; height: 64px; }
        
        /* 等待界面 */
        .waiting-screen {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.9); z-index: 2000; text-align: center;
        }
        .loading-spinner {
            width: 60px; height: 60px; border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid #4CAF50; border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 30px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* 输入表单 */
        .input-form {
            max-width: 400px; width: 90%; background: rgba(255,255,255,0.1);
            padding: 30px; border-radius: 20px; backdrop-filter: blur(20px);
        }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; color: white; font-weight: 500; }
        .form-input {
            width: 100%; padding: 12px 16px; border: 1px solid rgba(255,255,255,0.3);
            border-radius: 8px; background: rgba(255,255,255,0.1);
            color: white; font-size: 14px; outline: none;
        }
        .form-input::placeholder { color: rgba(255,255,255,0.6); }
        .form-input:focus { border-color: #4CAF50; }
        .form-textarea { min-height: 80px; resize: vertical; }
        .form-select {
            width: 100%; padding: 12px 16px; border: 1px solid rgba(255,255,255,0.3);
            border-radius: 8px; background: rgba(255,255,255,0.1);
            color: white; font-size: 14px; outline: none;
        }
        .form-select option { background: #333; color: white; }
        
        .btn-primary {
            width: 100%; padding: 15px; border: none; border-radius: 8px;
            background: linear-gradient(135deg, #4CAF50, #45A049);
            color: white; font-size: 16px; font-weight: bold; cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(76, 175, 80, 0.3); }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        
        .btn-secondary {
            flex: 1; padding: 10px; border: 1px solid rgba(255,255,255,0.3);
            border-radius: 8px; background: transparent; color: white;
            cursor: pointer; transition: all 0.3s ease;
        }
        .btn-secondary:hover { background: rgba(255,255,255,0.1); }
        
        /* 错误提示 */
        .error-screen {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.9); z-index: 3000; text-align: center;
        }
        .error-title { color: #e74c3c; font-size: 24px; margin-bottom: 10px; }
        .error-message { margin-bottom: 20px; }
        
        .hidden { display: none !important; }
        
        /* 等待提示 */
        .waiting-info { max-width: 500px; text-align: center; }
        .waiting-icon { font-size: 120px; margin-bottom: 20px; opacity: 0.3; }
        .waiting-title { font-size: 24px; margin-bottom: 10px; }
        .waiting-text { font-size: 16px; opacity: 0.8; }
    </style>
</head>
<body>
    <div class="container">
        <!-- 状态栏 -->
        <div class="status-bar">
            <div class="room-info">
                <div class="room-id" id="roomDisplay">房间: -</div>
                <div class="connection-status" id="statusDisplay">初始化中...</div>
            </div>
        </div>
        
        <!-- 视频模式 -->
        <div id="videoMode" class="video-container hidden">
            <video id="remoteVideo" class="remote-video" autoplay playsinline></video>
            <video id="localVideo" class="local-video" autoplay playsinline muted></video>
        </div>
        
        <!-- 音频模式 -->
        <div id="audioMode" class="audio-mode hidden">
            <div class="avatar">
                <div class="avatar-icon">🎧</div>
            </div>
            <h2 id="remoteUserName">音频通话中</h2>
        </div>
        
        <!-- 控制按钮 -->
        <div class="controls">
            <button id="muteBtn" class="control-btn" title="静音/取消静音">🎤</button>
            <button id="videoBtn" class="control-btn hidden" title="开关视频">📹</button>
            <button id="hangupBtn" class="control-btn hangup" title="挂断">📞</button>
        </div>
        
        <!-- 等待界面（自动连接） -->
        <div id="autoConnectScreen" class="waiting-screen hidden">
            <div class="loading-spinner"></div>
            <h2 id="autoConnectTitle">正在连接...</h2>
            <p id="autoConnectMessage">请稍候</p>
        </div>
        
        <!-- 手动输入界面 -->
        <div id="manualInputScreen" class="waiting-screen">
            <div class="input-form">
                <h2 style="text-align: center; margin-bottom: 30px; color: #4CAF50;">🔑 手动输入RTC参数</h2>
                
                <div class="form-group">
                    <label class="form-label">AppID：</label>
                    <input type="text" id="appIdInput" class="form-input" placeholder="输入阿里云RTC AppID">
                </div>
                
                <div class="form-group">
                    <label class="form-label">频道ID：</label>
                    <input type="text" id="channelIdInput" class="form-input" placeholder="输入房间/频道ID">
                </div>
                
                <div class="form-group">
                    <label class="form-label">用户ID：</label>
                    <input type="text" id="userIdInput" class="form-input" placeholder="输入用户ID">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Token：</label>
                    <textarea id="tokenInput" class="form-input form-textarea" placeholder="输入阿里云RTC Token"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">通话模式：</label>
                    <select id="modeSelect" class="form-select">
                        <option value="video">视频通话</option>
                        <option value="audio">音频通话</option>
                    </select>
                </div>
                
                <button id="joinBtn" class="btn-primary">加入会话</button>
                
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button id="saveBtn" class="btn-secondary">保存设置</button>
                    <button id="loadBtn" class="btn-secondary">加载设置</button>
                </div>
                
                <p style="margin-top: 20px; font-size: 12px; opacity: 0.7; text-align: center;">
                    ❗ 所有参数都是必填的，特别是Token！<br>
                    阿里云RTC必须有有效的Token才能连接。
                </p>
            </div>
        </div>
        
        <!-- 等待对方加入 -->
        <div id="waitingUserScreen" class="waiting-screen hidden">
            <div class="waiting-info">
                <div class="waiting-icon" id="waitingIcon">👥</div>
                <h2 class="waiting-title">等待对方加入</h2>
                <p class="waiting-text" id="waitingText">已成功加入房间，等待其他用户加入通话...</p>
            </div>
        </div>
        
        <!-- 错误界面 -->
        <div id="errorScreen" class="error-screen hidden">
            <h2 class="error-title">连接失败</h2>
            <p class="error-message" id="errorMessage">发生了未知错误</p>
            <div>
                <button onclick="location.reload()" class="btn-primary" style="width: auto; padding: 10px 20px;">重新尝试</button>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        // 全局变量
        let rtcClient = null;
        let localTracks = { audio: null, video: null };
        let isJoined = false;
        let currentMode = 'video';
        let roomParams = null;
        
        // 应用类
        class RTCApp {
            constructor() {
                this.init();
            }
            
            async init() {
                console.log('📱 RTC应用初始化...');
                try {
                    await this.loadSDK();
                    roomParams = this.parseURLParams();
                    
                    console.log('🔍 参数检查结果:', roomParams);
                    
                    if (roomParams && this.validateParams(roomParams)) {
                        console.log('🎉 参数有效，开始自动连接...');
                        this.showAutoConnect(roomParams);
                        // 稍微延迟一下让用户看到界面变化
                        setTimeout(() => this.joinRoom(roomParams), 1500);
                    } else {
                        console.log('👩\u200d💻 参数不完整，显示手动输入界面');
                        this.showManualInput();
                    }
                    
                    this.setupEventListeners();
                } catch (error) {
                    console.error('❌ 初始化失败:', error);
                    this.showError('SDK加载失败: ' + error.message);
                }
            }
            
            async loadSDK() {
                console.log('📦 加载阿里云RTC SDK...');
                const sdkUrls = [
                    'https://g.alicdn.com/dingding/dingrtc-sdk/3.6.0/aliyun-webrtc-sdk.js',
                    'https://dingrtc.oss-cn-zhangjiakou.aliyuncs.com/sdk/web/index.umd.3.6.0.js'
                ];
                
                for (const url of sdkUrls) {
                    try {
                        await this.loadScript(url);
                        if (typeof DingRTC !== 'undefined' && DingRTC.default) {
                            console.log('✅ SDK加载成功');
                            return;
                        }
                    } catch (error) {
                        console.warn('⚠️ SDK加载失败:', url, error);
                    }
                }
                throw new Error('所有SDK源都无法加载');
            }
            
            loadScript(src) {
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = src;
                    script.onload = resolve;
                    script.onerror = reject;
                    document.head.appendChild(script);
                });
            }
            
            parseURLParams() {
                const urlString = window.location.href;
                const params = new URLSearchParams(window.location.search);
                
                console.log('🔍 当前URL:', urlString);
                console.log('🔍 搜索参数:', window.location.search);
                
                const roomId = params.get('roomId');
                const userId = params.get('userId');
                const appId = params.get('appId');
                const mode = params.get('mode') || 'video';
                const token = params.get('token');
                
                console.log('🔍 解析URL参数:');
                console.log('  - roomId:', roomId);
                console.log('  - userId:', userId);
                console.log('  - appId:', appId);
                console.log('  - mode:', mode);
                console.log('  - token长度:', token ? token.length : 0);
                
                // ✅ 所有参数都必须存在，包括token！
                if (roomId && userId && appId && token) {
                    const result = { roomId, userId, appId, mode, token };
                    console.log('✅ 检测到有效参数（包括token），将自动连接');
                    return result;
                }
                
                console.log('❌ 参数不完整（缺少token或其他必要参数），显示手动输入界面');
                console.log('ℹ️ 提示：需要roomId、userId、appId和token才能自动连接');
                return null;
            }
            
            validateParams(params) {
                console.log('📋 验证参数:', params);
                
                // ✅ 必要参数：roomId, userId, appId, token（token是必须的！）
                const required = ['roomId', 'userId', 'appId', 'token'];
                const isValid = required.every(key => {
                    const value = params[key];
                    const valid = value && value.trim().length > 0;
                    if (!valid) {
                        console.log(`❌ 参数 ${key} 无效:`, value);
                    }
                    return valid;
                });
                
                console.log('📋 参数验证结果:', isValid);
                
                if (!isValid) {
                    const missingParams = required.filter(key => !params[key] || !params[key].trim());
                    console.log('❌ 缺少必要参数:', missingParams);
                }
                
                return isValid;
            }
            
            showAutoConnect(params) {
                document.getElementById('autoConnectScreen').classList.remove('hidden');
                document.getElementById('manualInputScreen').classList.add('hidden');
                
                document.getElementById('autoConnectTitle').textContent = '检测到房间信息';
                document.getElementById('autoConnectMessage').innerHTML = `
                    <p>房间ID: ${params.roomId}</p>
                    <p>用户ID: ${params.userId}</p>
                    <p>通话模式: ${params.mode === 'video' ? '视频通话' : '音频通话'}</p>
                    <p>正在自动连接...</p>
                `;
                
                document.getElementById('roomDisplay').textContent = `房间: ${params.roomId}`;
            }
            
            showManualInput() {
                document.getElementById('manualInputScreen').classList.remove('hidden');
                document.getElementById('autoConnectScreen').classList.add('hidden');
                
                // 清空所有输入框，严格遵循规范
                const inputs = ['appIdInput', 'channelIdInput', 'userIdInput', 'tokenInput'];
                inputs.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) element.value = '';
                });
                
                console.log('✨ 显示手动输入界面，所有字段已清空');
            }
            
            showError(message) {
                document.getElementById('errorMessage').textContent = message;
                document.getElementById('errorScreen').classList.remove('hidden');
                this.hideAllScreens();
            }
            
            hideAllScreens() {
                const screens = ['autoConnectScreen', 'manualInputScreen', 'waitingUserScreen'];
                screens.forEach(id => {
                    document.getElementById(id).classList.add('hidden');
                });
            }
            
            showWaitingUser(mode) {
                this.hideAllScreens();
                document.getElementById('waitingUserScreen').classList.remove('hidden');
                
                const icon = mode === 'video' ? '🎥' : '🎧';
                const text = mode === 'video' ? '等待对方开启视频...' : '正在进行音频通话...';
                
                document.getElementById('waitingIcon').textContent = icon;
                document.getElementById('waitingText').textContent = text;
            }
            
            setupEventListeners() {
                document.getElementById('joinBtn').onclick = () => {
                    const params = this.getManualParams();
                    console.log('🔄 手动加入参数:', params);
                    
                    if (this.validateParams(params)) {
                        this.joinRoom(params);
                    } else {
                        // 更详细的错误提示
                        const missing = [];
                        if (!params.appId?.trim()) missing.push('AppID');
                        if (!params.roomId?.trim()) missing.push('房间ID');
                        if (!params.userId?.trim()) missing.push('用户ID');
                        if (!params.token?.trim()) missing.push('Token');
                        
                        alert(`请填写完整的参数信息！\n缺少: ${missing.join('、')}`);
                    }
                };
                
                document.getElementById('saveBtn').onclick = () => this.saveSettings();
                document.getElementById('loadBtn').onclick = () => this.loadSettings();
                
                document.getElementById('muteBtn').onclick = () => this.toggleMute();
                document.getElementById('videoBtn').onclick = () => this.toggleVideo();
                document.getElementById('hangupBtn').onclick = () => this.hangup();
            }
            
            getManualParams() {
                return {
                    appId: document.getElementById('appIdInput').value.trim(),
                    roomId: document.getElementById('channelIdInput').value.trim(),
                    userId: document.getElementById('userIdInput').value.trim(),
                    token: document.getElementById('tokenInput').value.trim(),
                    mode: document.getElementById('modeSelect').value
                };
            }
            
            saveSettings() {
                try {
                    const params = this.getManualParams();
                    localStorage.setItem('rtc_settings', JSON.stringify(params));
                    alert('设置已保存！');
                } catch (error) {
                    alert('保存失败: ' + error.message);
                }
            }
            
            loadSettings() {
                try {
                    const saved = localStorage.getItem('rtc_settings');
                    if (saved) {
                        const params = JSON.parse(saved);
                        document.getElementById('appIdInput').value = params.appId || '';
                        document.getElementById('channelIdInput').value = params.roomId || '';
                        document.getElementById('userIdInput').value = params.userId || '';
                        document.getElementById('tokenInput').value = params.token || '';
                        document.getElementById('modeSelect').value = params.mode || 'video';
                        alert('设置已加载！');
                    } else {
                        alert('没有保存的设置');
                    }
                } catch (error) {
                    alert('加载失败: ' + error.message);
                }
            }
            
            async joinRoom(params) {
                try {
                    console.log('🚀 开始加入房间:', params);
                    
                    this.hideAllScreens();
                    document.getElementById('autoConnectScreen').classList.remove('hidden');
                    document.getElementById('autoConnectTitle').textContent = '正在连接...';
                    document.getElementById('autoConnectMessage').textContent = '正在初始化RTC引擎...';
                    
                    currentMode = params.mode;
                    
                    if (!rtcClient) {
                        const RtcEngine = DingRTC.default;
                        if (!RtcEngine.checkSystemRequirements()) {
                            throw new Error('当前环境不支持RTC通信');
                        }
                        rtcClient = RtcEngine.createClient();
                        this.setupRTCEvents();
                    }
                    
                    document.getElementById('autoConnectMessage').textContent = '正在创建音视频流...';
                    await this.createLocalTracks(params.mode);
                    
                    document.getElementById('autoConnectMessage').textContent = '正在加入房间...';
                    
                    // ✅ 验证token是否存在且有效
                    if (!params.token || !params.token.trim()) {
                        throw new Error('Token不能为空！阿里云RTC必须有有效的Token才能连接。');
                    }
                    
                    const authInfo = {
                        appId: params.appId,
                        token: params.token,
                        uid: params.userId,
                        channel: params.roomId,
                        userName: params.userId
                    };
                    
                    console.log('🔑 认证信息:', {
                        appId: authInfo.appId,
                        channel: authInfo.channel,
                        uid: authInfo.uid,
                        userName: authInfo.userName,
                        tokenLength: authInfo.token.length
                    });
                    
                    await rtcClient.join(authInfo);
                    
                    isJoined = true;
                    console.log('✅ 成功加入房间');
                    
                    if (localTracks.audio || localTracks.video) {
                        const tracksToPublish = [];
                        if (localTracks.audio) tracksToPublish.push(localTracks.audio);
                        if (localTracks.video) tracksToPublish.push(localTracks.video);
                        
                        await rtcClient.publish(tracksToPublish);
                        console.log('✅ 本地流发布成功');
                    }
                    
                    if (localTracks.video) {
                        localTracks.video.play('localVideo');
                    }
                    
                    this.updateUI();
                    this.showWaitingUser(params.mode);
                    
                    document.getElementById('roomDisplay').textContent = `房间: ${params.roomId}`;
                    document.getElementById('statusDisplay').textContent = '等待对方加入...';
                    
                } catch (error) {
                    console.error('❌ 加入房间失败:', error);
                    this.showError('加入房间失败: ' + error.message);
                }
            }
            
            async createLocalTracks(mode) {
                const RtcEngine = DingRTC.default;
                localTracks.audio = await RtcEngine.createMicrophoneAudioTrack();
                if (mode === 'video') {
                    localTracks.video = await RtcEngine.createCameraVideoTrack();
                }
                console.log('✅ 本地tracks创建成功');
            }
            
            setupRTCEvents() {
                console.log('🎭 设置RTC事件监听');
                
                rtcClient.on('user-joined', (user) => {
                    console.log('👤 用户加入:', user);
                    document.getElementById('statusDisplay').textContent = `已连接: ${user.userName || user.uid}`;
                });
                
                rtcClient.on('user-published', async (user, mediaType, auxiliary) => {
                    console.log('📡 用户发布流:', user.userName || user.uid, mediaType);
                    
                    const track = await rtcClient.subscribe(user.userId, mediaType, auxiliary);
                    
                    if (mediaType === 'video') {
                        track.play('remoteVideo');
                        document.getElementById('statusDisplay').textContent = '通话中...';
                        this.hideAllScreens();
                        document.getElementById('videoMode').classList.remove('hidden');
                    } else if (mediaType === 'audio') {
                        track.play();
                        if (currentMode === 'audio') {
                            this.hideAllScreens();
                            document.getElementById('audioMode').classList.remove('hidden');
                            document.getElementById('remoteUserName').textContent = `音频通话: ${user.userName || user.uid}`;
                        }
                    }
                });
                
                rtcClient.on('user-left', (user) => {
                    console.log('👋 用户离开:', user);
                    document.getElementById('statusDisplay').textContent = '等待对方加入...';
                    this.showWaitingUser(currentMode);
                });
            }
            
            updateUI() {
                if (currentMode === 'video') {
                    document.getElementById('videoBtn').classList.remove('hidden');
                } else {
                    document.getElementById('videoBtn').classList.add('hidden');
                }
            }
            
            toggleMute() {
                if (localTracks.audio) {
                    const enabled = localTracks.audio.enabled;
                    localTracks.audio.setEnabled(!enabled);
                    const btn = document.getElementById('muteBtn');
                    if (!enabled) {
                        btn.classList.remove('muted');
                        btn.textContent = '🎤';
                    } else {
                        btn.classList.add('muted');
                        btn.textContent = '🔇';
                    }
                }
            }
            
            toggleVideo() {
                if (localTracks.video) {
                    const enabled = localTracks.video.enabled;
                    localTracks.video.setEnabled(!enabled);
                    const btn = document.getElementById('videoBtn');
                    if (!enabled) {
                        btn.classList.remove('muted');
                        btn.textContent = '📹';
                    } else {
                        btn.classList.add('muted');
                        btn.textContent = '📷';
                    }
                }
            }
            
            async hangup() {
                try {
                    if (localTracks.audio) {
                        localTracks.audio.stop();
                        localTracks.audio.close();
                    }
                    if (localTracks.video) {
                        localTracks.video.stop();
                        localTracks.video.close();
                    }
                    
                    if (rtcClient && isJoined) {
                        await rtcClient.leave();
                    }
                    
                    if (window.history.length > 1) {
                        window.history.back();
                    } else {
                        window.close();
                    }
                } catch (error) {
                    console.error('挂断失败:', error);
                    window.close();
                }
            }
        }
        
        // 启动应用
        window.onload = () => {
            new RTCApp();
        };
    </script>
</body>
</html>