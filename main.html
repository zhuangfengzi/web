<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é˜¿é‡Œäº‘RTCè§†é¢‘èŠå¤©</title>
    <link rel="preload" href="https://g.alicdn.com/dingding/dingrtc-sdk/3.6.0/aliyun-webrtc-sdk.js" as="script">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'PingFang SC', sans-serif;
            background: linear-gradient(135deg, #1A1A2E 0%, #16213E 100%);
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
            color: white;
        }
        .container { flex: 1; position: relative; }
        
        /* çŠ¶æ€æ  */
        .status-bar {
            position: absolute; top: 0; left: 0; right: 0; padding: 20px;
            background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, transparent 100%);
            z-index: 1000; display: flex; justify-content: space-between; align-items: center;
        }
        .room-info { display: flex; flex-direction: column; }
        .room-id { font-size: 14px; opacity: 0.8; }
        .connection-status { font-size: 16px; font-weight: bold; }
        
        /* è§†é¢‘åŒºåŸŸ */
        .video-container { 
            width: 100%; height: 100%; position: relative; background: #000;
            display: flex; align-items: center; justify-content: center;
        }
        .remote-video { width: 100%; height: 100%; object-fit: cover; }
        .local-video {
            position: absolute; top: 80px; right: 20px; width: 120px; height: 160px;
            border: 2px solid rgba(255,255,255,0.3); border-radius: 12px; object-fit: cover;
            background: #333;
        }
        
        /* éŸ³é¢‘æ¨¡å¼ */
        .audio-mode {
            flex: 1; display: flex; flex-direction: column; align-items: center;
            justify-content: center; text-align: center; padding: 40px;
        }
        .avatar {
            width: 200px; height: 200px; border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex; align-items: center; justify-content: center; margin-bottom: 20px;
        }
        .avatar-icon { font-size: 80px; }
        
        /* æ§åˆ¶æŒ‰é’® */
        .controls {
            position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 20px; padding: 20px; background: rgba(0,0,0,0.4);
            border-radius: 50px; backdrop-filter: blur(20px);
        }
        .control-btn {
            width: 56px; height: 56px; border: none; border-radius: 50%;
            background: rgba(255,255,255,0.15); color: white; font-size: 24px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: all 0.3s ease;
        }
        .control-btn:hover { background: rgba(255,255,255,0.25); }
        .control-btn.active { background: #4CAF50; }
        .control-btn.muted { background: #e74c3c; }
        .control-btn.hangup { background: #e74c3c; width: 64px; height: 64px; }
        
        /* ç­‰å¾…ç•Œé¢ */
        .waiting-screen {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.9); z-index: 2000; text-align: center;
        }
        .loading-spinner {
            width: 60px; height: 60px; border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid #4CAF50; border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 30px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* è¾“å…¥è¡¨å• */
        .input-form {
            max-width: 400px; width: 90%; background: rgba(255,255,255,0.1);
            padding: 30px; border-radius: 20px; backdrop-filter: blur(20px);
        }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; color: white; font-weight: 500; }
        .form-input {
            width: 100%; padding: 12px 16px; border: 1px solid rgba(255,255,255,0.3);
            border-radius: 8px; background: rgba(255,255,255,0.1);
            color: white; font-size: 14px; outline: none;
        }
        .form-input::placeholder { color: rgba(255,255,255,0.6); }
        .form-input:focus { border-color: #4CAF50; }
        .form-textarea { min-height: 80px; resize: vertical; }
        .form-select {
            width: 100%; padding: 12px 16px; border: 1px solid rgba(255,255,255,0.3);
            border-radius: 8px; background: rgba(255,255,255,0.1);
            color: white; font-size: 14px; outline: none;
        }
        .form-select option { background: #333; color: white; }
        
        .btn-primary {
            width: 100%; padding: 15px; border: none; border-radius: 8px;
            background: linear-gradient(135deg, #4CAF50, #45A049);
            color: white; font-size: 16px; font-weight: bold; cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(76, 175, 80, 0.3); }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        
        .btn-secondary {
            flex: 1; padding: 10px; border: 1px solid rgba(255,255,255,0.3);
            border-radius: 8px; background: transparent; color: white;
            cursor: pointer; transition: all 0.3s ease;
        }
        .btn-secondary:hover { background: rgba(255,255,255,0.1); }
        
        /* é”™è¯¯æç¤º */
        .error-screen {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.9); z-index: 3000; text-align: center;
        }
        .error-title { color: #e74c3c; font-size: 24px; margin-bottom: 10px; }
        .error-message { margin-bottom: 20px; }
        
        .hidden { display: none !important; }
        
        /* ç­‰å¾…æç¤º */
        .waiting-info { max-width: 500px; text-align: center; }
        .waiting-icon { font-size: 120px; margin-bottom: 20px; opacity: 0.3; }
        .waiting-title { font-size: 24px; margin-bottom: 10px; }
        .waiting-text { font-size: 16px; opacity: 0.8; }
    </style>
</head>
<body>
    <div class="container">
        <!-- çŠ¶æ€æ  -->
        <div class="status-bar">
            <div class="room-info">
                <div class="room-id" id="roomDisplay">æˆ¿é—´: -</div>
                <div class="connection-status" id="statusDisplay">åˆå§‹åŒ–ä¸­...</div>
            </div>
        </div>
        
        <!-- è§†é¢‘æ¨¡å¼ -->
        <div id="videoMode" class="video-container hidden">
            <video id="remoteVideo" class="remote-video" autoplay playsinline></video>
            <video id="localVideo" class="local-video" autoplay playsinline muted></video>
        </div>
        
        <!-- éŸ³é¢‘æ¨¡å¼ -->
        <div id="audioMode" class="audio-mode hidden">
            <div class="avatar">
                <div class="avatar-icon">ğŸ§</div>
            </div>
            <h2 id="remoteUserName">éŸ³é¢‘é€šè¯ä¸­</h2>
        </div>
        
        <!-- æ§åˆ¶æŒ‰é’® -->
        <div class="controls">
            <button id="muteBtn" class="control-btn" title="é™éŸ³/å–æ¶ˆé™éŸ³">ğŸ¤</button>
            <button id="videoBtn" class="control-btn hidden" title="å¼€å…³è§†é¢‘">ğŸ“¹</button>
            <button id="hangupBtn" class="control-btn hangup" title="æŒ‚æ–­">ğŸ“</button>
        </div>
        
        <!-- ç­‰å¾…ç•Œé¢ï¼ˆè‡ªåŠ¨è¿æ¥ï¼‰ -->
        <div id="autoConnectScreen" class="waiting-screen hidden">
            <div class="loading-spinner"></div>
            <h2 id="autoConnectTitle">æ­£åœ¨è¿æ¥...</h2>
            <p id="autoConnectMessage">è¯·ç¨å€™</p>
        </div>
        
        <!-- æ‰‹åŠ¨è¾“å…¥ç•Œé¢ -->
        <div id="manualInputScreen" class="waiting-screen">
            <div class="input-form">
                <h2 style="text-align: center; margin-bottom: 30px; color: #4CAF50;">ğŸ”‘ æ‰‹åŠ¨è¾“å…¥RTCå‚æ•°</h2>
                
                <div class="form-group">
                    <label class="form-label">AppIDï¼š</label>
                    <input type="text" id="appIdInput" class="form-input" placeholder="è¾“å…¥é˜¿é‡Œäº‘RTC AppID">
                </div>
                
                <div class="form-group">
                    <label class="form-label">é¢‘é“IDï¼š</label>
                    <input type="text" id="channelIdInput" class="form-input" placeholder="è¾“å…¥æˆ¿é—´/é¢‘é“ID">
                </div>
                
                <div class="form-group">
                    <label class="form-label">ç”¨æˆ·IDï¼š</label>
                    <input type="text" id="userIdInput" class="form-input" placeholder="è¾“å…¥ç”¨æˆ·ID">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Tokenï¼š</label>
                    <textarea id="tokenInput" class="form-input form-textarea" placeholder="è¾“å…¥é˜¿é‡Œäº‘RTC Token"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">é€šè¯æ¨¡å¼ï¼š</label>
                    <select id="modeSelect" class="form-select">
                        <option value="video">è§†é¢‘é€šè¯</option>
                        <option value="audio">éŸ³é¢‘é€šè¯</option>
                    </select>
                </div>
                
                <button id="joinBtn" class="btn-primary">åŠ å…¥ä¼šè¯</button>
                
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button id="saveBtn" class="btn-secondary">ä¿å­˜è®¾ç½®</button>
                    <button id="loadBtn" class="btn-secondary">åŠ è½½è®¾ç½®</button>
                </div>
                
                <p style="margin-top: 20px; font-size: 12px; opacity: 0.7; text-align: center;">
                    â— æ‰€æœ‰å‚æ•°éƒ½æ˜¯å¿…å¡«çš„ï¼Œç‰¹åˆ«æ˜¯Tokenï¼<br>
                    é˜¿é‡Œäº‘RTCå¿…é¡»æœ‰æœ‰æ•ˆçš„Tokenæ‰èƒ½è¿æ¥ã€‚
                </p>
            </div>
        </div>
        
        <!-- ç­‰å¾…å¯¹æ–¹åŠ å…¥ -->
        <div id="waitingUserScreen" class="waiting-screen hidden">
            <div class="waiting-info">
                <div class="waiting-icon" id="waitingIcon">ğŸ‘¥</div>
                <h2 class="waiting-title">ç­‰å¾…å¯¹æ–¹åŠ å…¥</h2>
                <p class="waiting-text" id="waitingText">å·²æˆåŠŸåŠ å…¥æˆ¿é—´ï¼Œç­‰å¾…å…¶ä»–ç”¨æˆ·åŠ å…¥é€šè¯...</p>
            </div>
        </div>
        
        <!-- é”™è¯¯ç•Œé¢ -->
        <div id="errorScreen" class="error-screen hidden">
            <h2 class="error-title">è¿æ¥å¤±è´¥</h2>
            <p class="error-message" id="errorMessage">å‘ç”Ÿäº†æœªçŸ¥é”™è¯¯</p>
            <div>
                <button onclick="location.reload()" class="btn-primary" style="width: auto; padding: 10px 20px;">é‡æ–°å°è¯•</button>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        // å…¨å±€å˜é‡
        let rtcClient = null;
        let localTracks = { audio: null, video: null };
        let isJoined = false;
        let currentMode = 'video';
        let roomParams = null;
        
        // åº”ç”¨ç±»
        class RTCApp {
            constructor() {
                this.init();
            }
            
            async init() {
                console.log('ğŸ“± RTCåº”ç”¨åˆå§‹åŒ–...');
                try {
                    await this.loadSDK();
                    roomParams = this.parseURLParams();
                    
                    console.log('ğŸ” å‚æ•°æ£€æŸ¥ç»“æœ:', roomParams);
                    
                    if (roomParams && this.validateParams(roomParams)) {
                        console.log('ğŸ‰ å‚æ•°æœ‰æ•ˆï¼Œå¼€å§‹è‡ªåŠ¨è¿æ¥...');
                        this.showAutoConnect(roomParams);
                        // ç¨å¾®å»¶è¿Ÿä¸€ä¸‹è®©ç”¨æˆ·çœ‹åˆ°ç•Œé¢å˜åŒ–
                        setTimeout(() => this.joinRoom(roomParams), 1500);
                    } else {
                        console.log('ğŸ‘©\u200dğŸ’» å‚æ•°ä¸å®Œæ•´ï¼Œæ˜¾ç¤ºæ‰‹åŠ¨è¾“å…¥ç•Œé¢');
                        this.showManualInput();
                    }
                    
                    this.setupEventListeners();
                } catch (error) {
                    console.error('âŒ åˆå§‹åŒ–å¤±è´¥:', error);
                    this.showError('SDKåŠ è½½å¤±è´¥: ' + error.message);
                }
            }
            
            async loadSDK() {
                console.log('ğŸ“¦ åŠ è½½é˜¿é‡Œäº‘RTC SDK...');
                const sdkUrls = [
                    'https://g.alicdn.com/dingding/dingrtc-sdk/3.6.0/aliyun-webrtc-sdk.js',
                    'https://dingrtc.oss-cn-zhangjiakou.aliyuncs.com/sdk/web/index.umd.3.6.0.js'
                ];
                
                for (const url of sdkUrls) {
                    try {
                        await this.loadScript(url);
                        if (typeof DingRTC !== 'undefined' && DingRTC.default) {
                            console.log('âœ… SDKåŠ è½½æˆåŠŸ');
                            return;
                        }
                    } catch (error) {
                        console.warn('âš ï¸ SDKåŠ è½½å¤±è´¥:', url, error);
                    }
                }
                throw new Error('æ‰€æœ‰SDKæºéƒ½æ— æ³•åŠ è½½');
            }
            
            loadScript(src) {
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = src;
                    script.onload = resolve;
                    script.onerror = reject;
                    document.head.appendChild(script);
                });
            }
            
            parseURLParams() {
                const urlString = window.location.href;
                const params = new URLSearchParams(window.location.search);
                
                console.log('ğŸ” å½“å‰URL:', urlString);
                console.log('ğŸ” æœç´¢å‚æ•°:', window.location.search);
                
                const roomId = params.get('roomId');
                const userId = params.get('userId');
                const appId = params.get('appId');
                const mode = params.get('mode') || 'video';
                const token = params.get('token');
                
                console.log('ğŸ” è§£æURLå‚æ•°:');
                console.log('  - roomId:', roomId);
                console.log('  - userId:', userId);
                console.log('  - appId:', appId);
                console.log('  - mode:', mode);
                console.log('  - tokené•¿åº¦:', token ? token.length : 0);
                
                // âœ… æ‰€æœ‰å‚æ•°éƒ½å¿…é¡»å­˜åœ¨ï¼ŒåŒ…æ‹¬tokenï¼
                if (roomId && userId && appId && token) {
                    const result = { roomId, userId, appId, mode, token };
                    console.log('âœ… æ£€æµ‹åˆ°æœ‰æ•ˆå‚æ•°ï¼ˆåŒ…æ‹¬tokenï¼‰ï¼Œå°†è‡ªåŠ¨è¿æ¥');
                    return result;
                }
                
                console.log('âŒ å‚æ•°ä¸å®Œæ•´ï¼ˆç¼ºå°‘tokenæˆ–å…¶ä»–å¿…è¦å‚æ•°ï¼‰ï¼Œæ˜¾ç¤ºæ‰‹åŠ¨è¾“å…¥ç•Œé¢');
                console.log('â„¹ï¸ æç¤ºï¼šéœ€è¦roomIdã€userIdã€appIdå’Œtokenæ‰èƒ½è‡ªåŠ¨è¿æ¥');
                return null;
            }
            
            validateParams(params) {
                console.log('ğŸ“‹ éªŒè¯å‚æ•°:', params);
                
                // âœ… å¿…è¦å‚æ•°ï¼šroomId, userId, appId, tokenï¼ˆtokenæ˜¯å¿…é¡»çš„ï¼ï¼‰
                const required = ['roomId', 'userId', 'appId', 'token'];
                const isValid = required.every(key => {
                    const value = params[key];
                    const valid = value && value.trim().length > 0;
                    if (!valid) {
                        console.log(`âŒ å‚æ•° ${key} æ— æ•ˆ:`, value);
                    }
                    return valid;
                });
                
                console.log('ğŸ“‹ å‚æ•°éªŒè¯ç»“æœ:', isValid);
                
                if (!isValid) {
                    const missingParams = required.filter(key => !params[key] || !params[key].trim());
                    console.log('âŒ ç¼ºå°‘å¿…è¦å‚æ•°:', missingParams);
                }
                
                return isValid;
            }
            
            showAutoConnect(params) {
                document.getElementById('autoConnectScreen').classList.remove('hidden');
                document.getElementById('manualInputScreen').classList.add('hidden');
                
                document.getElementById('autoConnectTitle').textContent = 'æ£€æµ‹åˆ°æˆ¿é—´ä¿¡æ¯';
                document.getElementById('autoConnectMessage').innerHTML = `
                    <p>æˆ¿é—´ID: ${params.roomId}</p>
                    <p>ç”¨æˆ·ID: ${params.userId}</p>
                    <p>é€šè¯æ¨¡å¼: ${params.mode === 'video' ? 'è§†é¢‘é€šè¯' : 'éŸ³é¢‘é€šè¯'}</p>
                    <p>æ­£åœ¨è‡ªåŠ¨è¿æ¥...</p>
                `;
                
                document.getElementById('roomDisplay').textContent = `æˆ¿é—´: ${params.roomId}`;
            }
            
            showManualInput() {
                document.getElementById('manualInputScreen').classList.remove('hidden');
                document.getElementById('autoConnectScreen').classList.add('hidden');
                
                // æ¸…ç©ºæ‰€æœ‰è¾“å…¥æ¡†ï¼Œä¸¥æ ¼éµå¾ªè§„èŒƒ
                const inputs = ['appIdInput', 'channelIdInput', 'userIdInput', 'tokenInput'];
                inputs.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) element.value = '';
                });
                
                console.log('âœ¨ æ˜¾ç¤ºæ‰‹åŠ¨è¾“å…¥ç•Œé¢ï¼Œæ‰€æœ‰å­—æ®µå·²æ¸…ç©º');
            }
            
            showError(message) {
                document.getElementById('errorMessage').textContent = message;
                document.getElementById('errorScreen').classList.remove('hidden');
                this.hideAllScreens();
            }
            
            hideAllScreens() {
                const screens = ['autoConnectScreen', 'manualInputScreen', 'waitingUserScreen'];
                screens.forEach(id => {
                    document.getElementById(id).classList.add('hidden');
                });
            }
            
            showWaitingUser(mode) {
                this.hideAllScreens();
                document.getElementById('waitingUserScreen').classList.remove('hidden');
                
                const icon = mode === 'video' ? 'ğŸ¥' : 'ğŸ§';
                const text = mode === 'video' ? 'ç­‰å¾…å¯¹æ–¹å¼€å¯è§†é¢‘...' : 'æ­£åœ¨è¿›è¡ŒéŸ³é¢‘é€šè¯...';
                
                document.getElementById('waitingIcon').textContent = icon;
                document.getElementById('waitingText').textContent = text;
            }
            
            setupEventListeners() {
                document.getElementById('joinBtn').onclick = () => {
                    const params = this.getManualParams();
                    console.log('ğŸ”„ æ‰‹åŠ¨åŠ å…¥å‚æ•°:', params);
                    
                    if (this.validateParams(params)) {
                        this.joinRoom(params);
                    } else {
                        // æ›´è¯¦ç»†çš„é”™è¯¯æç¤º
                        const missing = [];
                        if (!params.appId?.trim()) missing.push('AppID');
                        if (!params.roomId?.trim()) missing.push('æˆ¿é—´ID');
                        if (!params.userId?.trim()) missing.push('ç”¨æˆ·ID');
                        if (!params.token?.trim()) missing.push('Token');
                        
                        alert(`è¯·å¡«å†™å®Œæ•´çš„å‚æ•°ä¿¡æ¯ï¼\nç¼ºå°‘: ${missing.join('ã€')}`);
                    }
                };
                
                document.getElementById('saveBtn').onclick = () => this.saveSettings();
                document.getElementById('loadBtn').onclick = () => this.loadSettings();
                
                document.getElementById('muteBtn').onclick = () => this.toggleMute();
                document.getElementById('videoBtn').onclick = () => this.toggleVideo();
                document.getElementById('hangupBtn').onclick = () => this.hangup();
            }
            
            getManualParams() {
                return {
                    appId: document.getElementById('appIdInput').value.trim(),
                    roomId: document.getElementById('channelIdInput').value.trim(),
                    userId: document.getElementById('userIdInput').value.trim(),
                    token: document.getElementById('tokenInput').value.trim(),
                    mode: document.getElementById('modeSelect').value
                };
            }
            
            saveSettings() {
                try {
                    const params = this.getManualParams();
                    localStorage.setItem('rtc_settings', JSON.stringify(params));
                    alert('è®¾ç½®å·²ä¿å­˜ï¼');
                } catch (error) {
                    alert('ä¿å­˜å¤±è´¥: ' + error.message);
                }
            }
            
            loadSettings() {
                try {
                    const saved = localStorage.getItem('rtc_settings');
                    if (saved) {
                        const params = JSON.parse(saved);
                        document.getElementById('appIdInput').value = params.appId || '';
                        document.getElementById('channelIdInput').value = params.roomId || '';
                        document.getElementById('userIdInput').value = params.userId || '';
                        document.getElementById('tokenInput').value = params.token || '';
                        document.getElementById('modeSelect').value = params.mode || 'video';
                        alert('è®¾ç½®å·²åŠ è½½ï¼');
                    } else {
                        alert('æ²¡æœ‰ä¿å­˜çš„è®¾ç½®');
                    }
                } catch (error) {
                    alert('åŠ è½½å¤±è´¥: ' + error.message);
                }
            }
            
            async joinRoom(params) {
                try {
                    console.log('ğŸš€ å¼€å§‹åŠ å…¥æˆ¿é—´:', params);
                    
                    this.hideAllScreens();
                    document.getElementById('autoConnectScreen').classList.remove('hidden');
                    document.getElementById('autoConnectTitle').textContent = 'æ­£åœ¨è¿æ¥...';
                    document.getElementById('autoConnectMessage').textContent = 'æ­£åœ¨åˆå§‹åŒ–RTCå¼•æ“...';
                    
                    currentMode = params.mode;
                    
                    if (!rtcClient) {
                        const RtcEngine = DingRTC.default;
                        if (!RtcEngine.checkSystemRequirements()) {
                            throw new Error('å½“å‰ç¯å¢ƒä¸æ”¯æŒRTCé€šä¿¡');
                        }
                        rtcClient = RtcEngine.createClient();
                        this.setupRTCEvents();
                    }
                    
                    document.getElementById('autoConnectMessage').textContent = 'æ­£åœ¨åˆ›å»ºéŸ³è§†é¢‘æµ...';
                    await this.createLocalTracks(params.mode);
                    
                    document.getElementById('autoConnectMessage').textContent = 'æ­£åœ¨åŠ å…¥æˆ¿é—´...';
                    
                    // âœ… éªŒè¯tokenæ˜¯å¦å­˜åœ¨ä¸”æœ‰æ•ˆ
                    if (!params.token || !params.token.trim()) {
                        throw new Error('Tokenä¸èƒ½ä¸ºç©ºï¼é˜¿é‡Œäº‘RTCå¿…é¡»æœ‰æœ‰æ•ˆçš„Tokenæ‰èƒ½è¿æ¥ã€‚');
                    }
                    
                    const authInfo = {
                        appId: params.appId,
                        token: params.token,
                        uid: params.userId,
                        channel: params.roomId,
                        userName: params.userId
                    };
                    
                    console.log('ğŸ”‘ è®¤è¯ä¿¡æ¯:', {
                        appId: authInfo.appId,
                        channel: authInfo.channel,
                        uid: authInfo.uid,
                        userName: authInfo.userName,
                        tokenLength: authInfo.token.length
                    });
                    
                    await rtcClient.join(authInfo);
                    
                    isJoined = true;
                    console.log('âœ… æˆåŠŸåŠ å…¥æˆ¿é—´');
                    
                    if (localTracks.audio || localTracks.video) {
                        const tracksToPublish = [];
                        if (localTracks.audio) tracksToPublish.push(localTracks.audio);
                        if (localTracks.video) tracksToPublish.push(localTracks.video);
                        
                        await rtcClient.publish(tracksToPublish);
                        console.log('âœ… æœ¬åœ°æµå‘å¸ƒæˆåŠŸ');
                    }
                    
                    if (localTracks.video) {
                        localTracks.video.play('localVideo');
                    }
                    
                    this.updateUI();
                    this.showWaitingUser(params.mode);
                    
                    document.getElementById('roomDisplay').textContent = `æˆ¿é—´: ${params.roomId}`;
                    document.getElementById('statusDisplay').textContent = 'ç­‰å¾…å¯¹æ–¹åŠ å…¥...';
                    
                } catch (error) {
                    console.error('âŒ åŠ å…¥æˆ¿é—´å¤±è´¥:', error);
                    this.showError('åŠ å…¥æˆ¿é—´å¤±è´¥: ' + error.message);
                }
            }
            
            async createLocalTracks(mode) {
                const RtcEngine = DingRTC.default;
                localTracks.audio = await RtcEngine.createMicrophoneAudioTrack();
                if (mode === 'video') {
                    localTracks.video = await RtcEngine.createCameraVideoTrack();
                }
                console.log('âœ… æœ¬åœ°tracksåˆ›å»ºæˆåŠŸ');
            }
            
            setupRTCEvents() {
                console.log('ğŸ­ è®¾ç½®RTCäº‹ä»¶ç›‘å¬');
                
                rtcClient.on('user-joined', (user) => {
                    console.log('ğŸ‘¤ ç”¨æˆ·åŠ å…¥:', user);
                    document.getElementById('statusDisplay').textContent = `å·²è¿æ¥: ${user.userName || user.uid}`;
                });
                
                rtcClient.on('user-published', async (user, mediaType, auxiliary) => {
                    console.log('ğŸ“¡ ç”¨æˆ·å‘å¸ƒæµ:', user.userName || user.uid, mediaType);
                    
                    const track = await rtcClient.subscribe(user.userId, mediaType, auxiliary);
                    
                    if (mediaType === 'video') {
                        track.play('remoteVideo');
                        document.getElementById('statusDisplay').textContent = 'é€šè¯ä¸­...';
                        this.hideAllScreens();
                        document.getElementById('videoMode').classList.remove('hidden');
                    } else if (mediaType === 'audio') {
                        track.play();
                        if (currentMode === 'audio') {
                            this.hideAllScreens();
                            document.getElementById('audioMode').classList.remove('hidden');
                            document.getElementById('remoteUserName').textContent = `éŸ³é¢‘é€šè¯: ${user.userName || user.uid}`;
                        }
                    }
                });
                
                rtcClient.on('user-left', (user) => {
                    console.log('ğŸ‘‹ ç”¨æˆ·ç¦»å¼€:', user);
                    document.getElementById('statusDisplay').textContent = 'ç­‰å¾…å¯¹æ–¹åŠ å…¥...';
                    this.showWaitingUser(currentMode);
                });
            }
            
            updateUI() {
                if (currentMode === 'video') {
                    document.getElementById('videoBtn').classList.remove('hidden');
                } else {
                    document.getElementById('videoBtn').classList.add('hidden');
                }
            }
            
            toggleMute() {
                if (localTracks.audio) {
                    const enabled = localTracks.audio.enabled;
                    localTracks.audio.setEnabled(!enabled);
                    const btn = document.getElementById('muteBtn');
                    if (!enabled) {
                        btn.classList.remove('muted');
                        btn.textContent = 'ğŸ¤';
                    } else {
                        btn.classList.add('muted');
                        btn.textContent = 'ğŸ”‡';
                    }
                }
            }
            
            toggleVideo() {
                if (localTracks.video) {
                    const enabled = localTracks.video.enabled;
                    localTracks.video.setEnabled(!enabled);
                    const btn = document.getElementById('videoBtn');
                    if (!enabled) {
                        btn.classList.remove('muted');
                        btn.textContent = 'ğŸ“¹';
                    } else {
                        btn.classList.add('muted');
                        btn.textContent = 'ğŸ“·';
                    }
                }
            }
            
            async hangup() {
                try {
                    if (localTracks.audio) {
                        localTracks.audio.stop();
                        localTracks.audio.close();
                    }
                    if (localTracks.video) {
                        localTracks.video.stop();
                        localTracks.video.close();
                    }
                    
                    if (rtcClient && isJoined) {
                        await rtcClient.leave();
                    }
                    
                    if (window.history.length > 1) {
                        window.history.back();
                    } else {
                        window.close();
                    }
                } catch (error) {
                    console.error('æŒ‚æ–­å¤±è´¥:', error);
                    window.close();
                }
            }
        }
        
        // å¯åŠ¨åº”ç”¨
        window.onload = () => {
            new RTCApp();
        };
    </script>
</body>
</html>