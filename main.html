<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åª’ä½“æ’­æ”¾å™¨</title>
    <link rel="preload" href="https://g.alicdn.com/dingding/dingrtc-sdk/3.6.0/aliyun-webrtc-sdk.js" as="script">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #1A1A2E 0%, #16213E 100%);
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }
        .container { flex: 1; position: relative; }
        .status-bar {
            position: absolute; top: 0; left: 0; right: 0; padding: 20px;
            background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, transparent 100%);
            z-index: 1000; display: flex; justify-content: space-between; color: white;
        }
        .video-container { flex: 1; position: relative; background: #000; }
        .remote-video { width: 100%; height: 100%; object-fit: cover; }
        .local-video {
            position: absolute; top: 80px; right: 20px; width: 120px; height: 160px;
            border: 2px solid rgba(255,255,255,0.3); border-radius: 12px; object-fit: cover;
        }
        .audio-mode {
            flex: 1; display: flex; flex-direction: column; align-items: center;
            justify-content: center; text-align: center; padding: 40px;
        }
        .avatar {
            width: 200px; height: 200px; border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;
        }
        .avatar-icon { font-size: 80px; color: white; }
        .controls {
            position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 20px; padding: 20px; background: rgba(0,0,0,0.4);
            border-radius: 50px; backdrop-filter: blur(20px);
        }
        .control-btn {
            width: 56px; height: 56px; border: none; border-radius: 50%;
            background: rgba(255,255,255,0.15); color: white; font-size: 24px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .control-btn.hangup { background: #e74c3c; width: 64px; height: 64px; }
        .overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.9); color: white; text-align: center; z-index: 2000;
        }
        .loading-spinner {
            width: 60px; height: 60px; border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid #4CAF50; border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="container">
        <div class="status-bar">
            <div><span>ä¼šè¯: </span><span id="sessionId">-</span></div>
            <div id="connectionStatus">è¿æ¥ä¸­...</div>
        </div>
        
        <div id="videoMode" class="video-container hidden">
            <video id="remoteVideo" class="remote-video" autoplay playsinline></video>
            <video id="localVideo" class="local-video" autoplay playsinline muted></video>
        </div>
        
        <div id="audioMode" class="audio-mode hidden">
            <div class="avatar"><div class="avatar-icon">ğŸ§</div></div>
            <h2 id="remoteUserName" style="color: white;">ç­‰å¾…è¿æ¥...</h2>
        </div>
        
        <div class="controls">
            <button id="muteBtn" class="control-btn">ğŸ¤</button>
            <button id="videoBtn" class="control-btn hidden">ğŸ“¹</button>
            <button id="hangupBtn" class="control-btn hangup">ğŸ“</button>
        </div>
        
        <div id="waitingScreen" class="overlay">
            <div style="max-width: 500px; margin: 0 auto; text-align: center;">
                <h2 style="margin-bottom: 30px; color: #4CAF50;">ğŸ”‘ æ‰‹åŠ¨è¾“å…¥RTCå‚æ•°</h2>
                
                <div style="text-align: left; margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; color: white;">AppIDï¼š</label>
                    <input type="text" id="manualAppId" placeholder="è¾“å…¥é˜¿é‡Œäº‘RTC AppID" style="
                        width: 100%; padding: 12px; border: 1px solid #333;
                        border-radius: 8px; background: rgba(255,255,255,0.1);
                        color: white; font-size: 16px; margin-bottom: 15px; outline: none;
                    ">
                </div>
                
                <div style="text-align: left; margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; color: white;">é¢‘é“IDï¼š</label>
                    <input type="text" id="manualChannelId" placeholder="è¾“å…¥æˆ¿é—´/é¢‘é“ID" style="
                        width: 100%; padding: 12px; border: 1px solid #333;
                        border-radius: 8px; background: rgba(255,255,255,0.1);
                        color: white; font-size: 16px; margin-bottom: 15px; outline: none;
                    ">
                </div>
                
                <div style="text-align: left; margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; color: white;">ç”¨æˆ·IDï¼š</label>
                    <input type="text" id="manualUserId" placeholder="è¾“å…¥ç”¨æˆ·ID" style="
                        width: 100%; padding: 12px; border: 1px solid #333;
                        border-radius: 8px; background: rgba(255,255,255,0.1);
                        color: white; font-size: 16px; margin-bottom: 15px; outline: none;
                    ">
                </div>
                
                <div style="text-align: left; margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; color: white;">Tokenï¼š</label>
                    <textarea id="manualToken" placeholder="è¾“å…¥æ‚¨çš„é˜¿é‡Œäº‘RTC Token" style="
                        width: 100%; padding: 12px; border: 1px solid #333;
                        border-radius: 8px; background: rgba(255,255,255,0.1);
                        color: white; font-size: 14px; margin-bottom: 15px; outline: none;
                        min-height: 80px; resize: vertical;
                    "></textarea>
                </div>
                
                <div style="text-align: left; margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; color: white;">é€šè¯æ¨¡å¼ï¼š</label>
                    <select id="manualMode" style="
                        width: 100%; padding: 12px; border: 1px solid #333;
                        border-radius: 8px; background: rgba(255,255,255,0.1);
                        color: white; font-size: 16px; margin-bottom: 15px; outline: none;
                    ">
                        <option value="video" style="background: #333;">è§†é¢‘é€šè¯</option>
                        <option value="audio" style="background: #333;">éŸ³é¢‘é€šè¯</option>
                    </select>
                </div>
                
                <button onclick="manualJoinSession()" style="
                    width: 100%; padding: 15px; border: none; border-radius: 8px;
                    background: #4CAF50; color: white; cursor: pointer; font-weight: bold;
                    font-size: 16px; margin-bottom: 15px;
                ">åŠ å…¥ä¼šè¯</button>
                
                <div style="display: flex; gap: 10px;">
                    <button onclick="saveManualInputs()" style="
                        flex: 1; padding: 10px; border: 1px solid #666;
                        border-radius: 8px; background: transparent;
                        color: white; cursor: pointer;
                    ">ä¿å­˜è®¾ç½®</button>
                    <button onclick="loadSavedInputs()" style="
                        flex: 1; padding: 10px; border: 1px solid #666;
                        border-radius: 8px; background: transparent;
                        color: white; cursor: pointer;
                    ">åŠ è½½è®¾ç½®</button>
                </div>
                
                <p style="margin-top: 20px; font-size: 12px; opacity: 0.7; color: white;">
                    æ‰‹åŠ¨è¾“å…¥æ¨¡å¼ï¼šæ‰€æœ‰å‚æ•°éƒ½ç”±æ‚¨æ‰‹åŠ¨å¡«å†™ï¼Œä¸ä¾èµ–URLå‚æ•°
                </p>
            </div>
        </div>
        
        <div id="errorScreen" class="overlay hidden">
            <h2 style="color: #e74c3c;">è¿æ¥å¤±è´¥</h2>
            <p id="errorMessage">å‘ç”Ÿäº†æœªçŸ¥é”™è¯¯</p>
            <div id="errorDetails" style="margin-top: 10px; font-size: 12px; opacity: 0.7; max-width: 500px;"></div>
            <div style="margin-top: 20px;">
                <button onclick="location.reload()" style="margin: 5px; padding: 10px 20px; border: none; border-radius: 5px; background: #4CAF50; color: white; cursor: pointer;">é‡æ–°å°è¯•</button>
                <button onclick="window.open('https://support.qq.com/products/168613', '_blank')" style="margin: 5px; padding: 10px 20px; border: none; border-radius: 5px; background: #2196F3; color: white; cursor: pointer;">è·å–å¸®åŠ©</button>
            </div>
        </div>
        
        <!-- æµ‹è¯•é¢æ¿ -->
        <div id="testPanel" class="overlay hidden" style="background: rgba(0,0,0,0.95); color: white; padding: 20px; overflow-y: auto;">
            <div style="max-width: 800px; margin: 0 auto;">
                <h2 style="text-align: center; margin-bottom: 30px;">ğŸ§ª åª’ä½“æµ‹è¯•é¢æ¿</h2>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px;">
                    <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px;">
                        <h3>ğŸ“¡ SDKçŠ¶æ€</h3>
                        <div id="testSdkStatus" style="margin: 10px 0; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 5px;">æ£€æŸ¥ä¸­...</div>
                        <button onclick="checkSDKStatus()" style="padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">åˆ·æ–°çŠ¶æ€</button>
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px;">
                        <h3>ğŸ” å‚æ•°è§£æ</h3>
                        <div id="testParamsStatus" style="margin: 10px 0; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 5px;">æœªè§£æ</div>
                        <button onclick="parseCurrentParams()" style="padding: 8px 16px; background: #2196F3; color: white; border: none; border-radius: 5px; cursor: pointer;">è§£æå‚æ•°</button>
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px;">
                        <h3>ğŸ”‘ é…ç½®çŠ¶æ€</h3>
                        <div id="testConfigStatus" style="margin: 10px 0; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 5px;">æ£€æŸ¥ä¸­...</div>
                        <button onclick="checkConfigStatus()" style="padding: 8px 16px; background: #FF9800; color: white; border: none; border-radius: 5px; cursor: pointer;">æ£€æŸ¥é…ç½®</button>
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px;">
                        <h3>ğŸ® æ§åˆ¶å°</h3>
                        <div id="testConsole" style="margin: 10px 0; padding: 10px; background: rgba(0,0,0,0.5); border-radius: 5px; font-family: monospace; font-size: 12px; max-height: 100px; overflow-y: auto;">ç­‰å¾…æ—¥å¿—...</div>
                        <button onclick="clearTestConsole()" style="padding: 8px 16px; background: #f44336; color: white; border: none; border-radius: 5px; cursor: pointer;">æ¸…ç©º</button>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 30px;">
                    <button onclick="closeTestPanel()" style="padding: 12px 24px; background: #666; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">å…³é—­æµ‹è¯•é¢æ¿</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // åª’ä½“èµ„æºåŠ è½½ç®¡ç†
        let sdkLoadPromise = null;
        
        function loadSDKWithRetry() {
            if (sdkLoadPromise) return sdkLoadPromise;
            
            // åª’ä½“åº“æº
            const sdkUrls = [
                // ä¸»è¦CDN
                'https://g.alicdn.com/dingding/dingrtc-sdk/3.6.0/aliyun-webrtc-sdk.js',
                // å¤‡ç”¨æº 1
                'https://dingrtc.oss-cn-zhangjiakou.aliyuncs.com/sdk/web/index.umd.3.6.0.js',
                // å¤‡ç”¨æº 2
                'https://rtc-web-static.oss-cn-hangzhou.aliyuncs.com/sdk/3.6.0/aliyun-webrtc-sdk.js',
                // å›½é™…CDNå¤‡ç”¨
                'https://cdn.jsdelivr.net/npm/@alicloud/rtc-sdk@3.6.0/dist/aliyun-webrtc-sdk.js',
                // å…¨çƒCDNå¤‡ç”¨
                'https://unpkg.com/@alicloud/rtc-sdk@3.6.0/dist/aliyun-webrtc-sdk.js'
            ];
            
            sdkLoadPromise = new Promise(async (resolve, reject) => {
                console.log('å¼€å§‹åŠ è½½åª’ä½“åº“...');
                
                for (let i = 0; i < sdkUrls.length; i++) {
                    try {
                        console.log(`å°è¯•åŠ è½½ (${i + 1}/${sdkUrls.length}):`, sdkUrls[i]);
                        
                        // è¶…æ—¶æ§åˆ¶
                        await Promise.race([
                            loadScript(sdkUrls[i]),
                            new Promise((_, reject) => 
                                setTimeout(() => reject(new Error('è¶…æ—¶')), 15000)
                            )
                        ]);
                        
                        // ç­‰å¾…åˆå§‹åŒ–å®Œæˆ
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        
                        // æ£€æŸ¥åŠ è½½çŠ¶æ€ï¼ˆæŒ‰ç…§å®˜æ–¹ç¤ºä¾‹ï¼‰
                        if (typeof DingRTC !== 'undefined' && DingRTC.default) {
                            console.log('åª’ä½“åº“åŠ è½½æˆåŠŸï¼Œè®¾ç½®AliRtcEngineå…¼å®¹åˆ«å');
                            window.AliRtcEngine = DingRTC.default;
                            resolve();
                            return;
                        } else {
                            console.warn(`åº“åŠ è½½å®Œæˆä½†DingRTCå¯¹è±¡æœªå®šä¹‰ (${i + 1})`);
                        }
                    } catch (error) {
                        console.warn(`åº“åŠ è½½å¤±è´¥ (${i + 1}):`, error.message);
                    }
                }
                
                // é™çº§å¤„ç†
                console.error('æ‰€æœ‰å®˜æ–¹æºéƒ½æ— æ³•åŠ è½½ï¼Œå°è¯•é™çº§å¤„ç†...');
                
                // æ£€æŸ¥å…¨å±€å¯¹è±¡
                if (typeof window.DingRTC !== 'undefined' && window.DingRTC.default) {
                    console.log('æ£€æµ‹åˆ°å…¨å±€å¯¹è±¡ï¼Œè®¾ç½®å…¼å®¹åˆ«å...');
                    window.AliRtcEngine = window.DingRTC.default;
                    resolve();
                    return;
                }
                
                reject(new Error('æ‰€æœ‰åª’ä½“æºéƒ½æ— æ³•åŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ä½¿ç”¨å…¶ä»–ç½‘ç»œç¯å¢ƒ'));
            });
            
            return sdkLoadPromise;
        }
        
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                // æ£€æŸ¥è„šæœ¬æ˜¯å¦å·²ç»å­˜åœ¨
                const existingScript = document.querySelector(`script[src="${src}"]`);
                if (existingScript) {
                    if (typeof AliRtcEngine !== 'undefined') {
                        resolve();
                        return;
                    }
                }
                
                const script = document.createElement('script');
                script.src = src;
                script.crossOrigin = 'anonymous';
                script.onload = () => {
                    console.log('è„šæœ¬åŠ è½½å®Œæˆ:', src);
                    resolve();
                };
                script.onerror = (error) => {
                    console.error('è„šæœ¬åŠ è½½é”™è¯¯:', src, error);
                    reject(new Error('Script load failed'));
                };
                
                document.head.appendChild(script);
            });
        }
        
        // ç½‘ç»œè¯Šæ–­åŠŸèƒ½
        async function diagnoseNetwork() {
            const results = [];
            
            // æ£€æŸ¥åŸºæœ¬ç½‘ç»œè¿æ¥
            try {
                const response = await fetch('https://www.baidu.com/favicon.ico', { 
                    method: 'HEAD', 
                    mode: 'no-cors',
                    cache: 'no-cache'
                });
                results.push('âœ… åŸºæœ¬ç½‘ç»œè¿æ¥æ­£å¸¸');
            } catch (error) {
                results.push('âŒ åŸºæœ¬ç½‘ç»œè¿æ¥å¤±è´¥');
            }
            
            // æ£€æŸ¥CDNè®¿é—®
            const cdnTests = [
                'https://g.alicdn.com',
                'https://cdn.jsdelivr.net',
                'https://unpkg.com'
            ];
            
            for (const cdn of cdnTests) {
                try {
                    await fetch(cdn + '/favicon.ico', { 
                        method: 'HEAD', 
                        mode: 'no-cors',
                        cache: 'no-cache',
                        signal: AbortSignal.timeout(5000)
                    });
                    results.push(`âœ… ${cdn} å¯è®¿é—®`);
                } catch (error) {
                    results.push(`âŒ ${cdn} ä¸å¯è®¿é—®`);
                }
            }
            
            return results;
        }
    </script>
    <script src="config.js"></script>
    <script>
        class MediaPlayer {
            constructor() {
                this.mediaEngine = null;
                this.sessionId = null;
                this.userId = null;
                this.appId = null;
                this.mode = 'video';
                this.cameraTrack = null;
                this.micTrack = null;
                this.token = null;
                this.init();
            }
            
            init() {
                console.log('æ‰‹åŠ¨è¾“å…¥æ¨¡å¼åˆå§‹åŒ–...');
                this.setupUI();
                // ä¸å†è°ƒç”¨fillExampleDataï¼Œä¹Ÿä¸è§£æURLå‚æ•°
                // ä¿æŒè¾“å…¥æ¡†ä¸ºç©ºï¼Œç­‰å¾…ç”¨æˆ·æ‰‹åŠ¨è¾“å…¥
                this.clearOldData();
                console.log('åˆå§‹åŒ–å®Œæˆï¼Œç­‰å¾…ç”¨æˆ·æ‰‹åŠ¨è¾“å…¥å‚æ•°...');
            }
            
            // æ¸…é™¤ä»»ä½•å¯èƒ½çš„ç¼“å­˜æ•°æ®å’Œåˆå§‹å€¼
            clearOldData() {
                // é¦–å…ˆå°è¯•ä» URL å‚æ•°è·å–æˆ¿é—´ä¿¡æ¯
                const urlParams = new URLSearchParams(window.location.search);
                const roomId = urlParams.get('roomId');
                const userId = urlParams.get('userId');
                const appId = urlParams.get('appId');
                const mode = urlParams.get('mode');
                const token = urlParams.get('token');
                
                console.log('æ£€æŸ¥URLå‚æ•°:', { roomId, userId, appId, mode, token: token ? 'YES' : 'NO' });
                
                // å¦‚æœ URL ä¸­æœ‰å‚æ•°ï¼Œå°±è‡ªåŠ¨å¡«å…¥
                if (roomId || userId || appId) {
                    console.log('æ£€æµ‹åˆ°URLå‚æ•°ï¼Œè‡ªåŠ¨å¡«å…¥...');
                    
                    if (appId) {
                        document.getElementById('manualAppId').value = appId;
                    }
                    if (roomId) {
                        document.getElementById('manualChannelId').value = roomId;
                    }
                    if (userId) {
                        document.getElementById('manualUserId').value = userId;
                    }
                    if (token) {
                        document.getElementById('manualToken').value = token;
                    }
                    if (mode) {
                        document.getElementById('manualMode').value = mode;
                    }
                    
                    // å¦‚æœæ‰€æœ‰å‚æ•°éƒ½æœ‰ï¼Œå¯ä»¥ç›´æ¥åŠ å…¥
                    if (roomId && userId && appId && token) {
                        console.log('æ‰€æœ‰å‚æ•°å®Œæ•´ï¼Œ3ç§’åè‡ªåŠ¨åŠ å…¥...');
                        
                        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
                        const waitingScreen = document.getElementById('waitingScreen');
                        waitingScreen.innerHTML = `
                            <div class="loading-spinner"></div>
                            <h2>æ£€æµ‹åˆ°æˆ¿é—´ä¿¡æ¯</h2>
                            <p>æ­£åœ¨è‡ªåŠ¨åŠ å…¥æˆ¿é—´: ${roomId}</p>
                            <p>ç”¨æˆ·ID: ${userId}</p>
                            <p>3ç§’åè‡ªåŠ¨è¿æ¥...</p>
                        `;
                        
                        setTimeout(() => {
                            manualJoinSession();
                        }, 3000);
                        return;
                    }
                } else {
                    // æ²¡æœ‰URLå‚æ•°ï¼Œç¡®ä¿æ‰€æœ‰è¾“å…¥æ¡†éƒ½ä¸ºç©º
                    const inputs = [
                        'manualAppId',
                        'manualChannelId', 
                        'manualUserId',
                        'manualToken'
                    ];
                    
                    inputs.forEach(id => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.value = '';
                        }
                    });
                }
                
                // è®¾ç½®é»˜è®¤æ¨¡å¼
                const modeSelect = document.getElementById('manualMode');
                if (modeSelect && !mode) {
                    modeSelect.value = 'video';
                }
            }
            

            
            parseParams() {
                const params = new URLSearchParams(window.location.search);
                try {
                    console.log('å½“å‰URLå‚æ•°:', window.location.search);
                    console.log('å®Œæ•´URL:', window.location.href);
                    
                    // è§£ç éšæ™¦å‚æ•°
                    const theme = params.get('theme');
                    const lang = params.get('lang');
                    const source = params.get('source');
                    const ref = params.get('ref');
                    const version = params.get('version'); // åŒ…å«ç¼–ç çš„AppID
                    const debug = params.get('debug');
                    const token = params.get('token'); // ç›´æ¥è·å–tokenå‚æ•°
                    
                    console.log('åŸå§‹å‚æ•°:', { theme, lang, source, ref, version, debug, token: token ? 'YES (' + token.length + ' chars)' : 'NO' });
                    
                    if (!theme || !lang || !source || !ref) {
                        throw new Error('ç¼ºå°‘å¿…è¦å‚æ•°: theme=' + theme + ', lang=' + lang + ', source=' + source + ', ref=' + ref);
                    }
                    
                    // é‡ç»„åŸå§‹å‚æ•° - ä¿®å¤åŒé‡è§£ç é—®é¢˜
                    try {
                        // å…ˆå°è¯•ç›´æ¥è§£ç ï¼ˆå¦‚æœå‚æ•°å·²ç»è¢«ç¼–ç ï¼‰
                        const themePart1 = atob(theme);
                        const langPart2 = atob(lang);
                        const sourcePart1 = atob(source);
                        const refPart2 = atob(ref);
                        
                        this.sessionId = themePart1 + langPart2;
                        this.userId = sourcePart1 + refPart2;
                        
                        console.log('è§£ç æˆåŠŸ:', {
                            themePart1,
                            langPart2,
                            sourcePart1,
                            refPart2,
                            sessionId: this.sessionId,
                            userId: this.userId
                        });
                        
                    } catch (decodeError) {
                        console.warn('ç›´æ¥è§£ç å¤±è´¥ï¼Œå°è¯•URIè§£ç :', decodeError);
                        // å¦‚æœç›´æ¥è§£ç å¤±è´¥ï¼Œå°è¯•å…ˆURIè§£ç 
                        const themePart1 = atob(decodeURIComponent(theme));
                        const langPart2 = atob(decodeURIComponent(lang));
                        const sourcePart1 = atob(decodeURIComponent(source));
                        const refPart2 = atob(decodeURIComponent(ref));
                        
                        this.sessionId = themePart1 + langPart2;
                        this.userId = sourcePart1 + refPart2;
                        
                        console.log('URIè§£ç æˆåŠŸ:', {
                            themePart1,
                            langPart2,
                            sourcePart1,
                            refPart2,
                            sessionId: this.sessionId,
                            userId: this.userId
                        });
                    }
                    this.mode = debug === 'false' ? 'video' : 'audio';
                    
                    // éªŒè¯è§£ç ç»“æœ
                    if (!this.sessionId || !this.userId) {
                        throw new Error('å‚æ•°è§£ç å¤±è´¥ï¼Œè·å¾—ç©ºçš„æˆ¿é—´IDæˆ–ç”¨æˆ·ID');
                    }
                    
                    if (this.sessionId.length < 5 || this.userId.length < 5) {
                        throw new Error('è§£ç ç»“æœå¤ªçŸ­ï¼Œå¯èƒ½è§£ç é”™è¯¯');
                    }
                    
                    console.log('æœ€ç»ˆè§£ç ç»“æœ:', {
                        sessionId: this.sessionId,
                        userId: this.userId,
                        mode: this.mode
                    });
                    
                    // å°è¯•ä»versionå‚æ•°è§£ç AppID
                    if (version) {
                        try {
                            this.encodedAppId = version;
                            console.log('ä»URLè·å–åˆ°ç¼–ç çš„AppID:', version);
                        } catch (e) {
                            console.warn('è§£ç AppIDå¤±è´¥:', e);
                        }
                    }
                    
                    // åœ¨è§£ç å‰å…ˆä¿å­˜token
                    if (token && token.trim()) {
                        console.log('ä»URLå‚æ•°è·å–åˆ°Tokenï¼Œä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨');
                        window.ALIYUN_CONFIG.saveTokenToStorage(token);
                    }
                    
                    // æ›´æ–°æ˜¾ç¤º
                    document.getElementById('sessionId').textContent = this.sessionId.substring(0, 15) + '...';
                    document.getElementById('waitingSessionId').textContent = this.sessionId.substring(0, 15) + '...';
                } catch (error) {
                    console.error('å‚æ•°è§£æé”™è¯¯:', error);
                    console.error('å½“å‰URL:', window.location.href);
                    this.showError('æ— æ•ˆçš„è®¿é—®é“¾æ¥: ' + error.message);
                }
            }
            
            setupUI() {
                const videoMode = document.getElementById('videoMode');
                const audioMode = document.getElementById('audioMode');
                const videoBtn = document.getElementById('videoBtn');
                
                // éšè—æ‰€æœ‰æ¨¡å¼
                videoMode.classList.add('hidden');
                audioMode.classList.add('hidden');
                
                // æ˜¾ç¤ºæ‰‹åŠ¨è¾“å…¥ç•Œé¢
                document.getElementById('waitingScreen').classList.remove('hidden');
            }
            
            // æ‰‹åŠ¨åŠ å…¥ä¼šè¯
            async manualJoinSession() {
                try {
                    // è·å–æ‰‹åŠ¨è¾“å…¥çš„å‚æ•°
                    this.appId = document.getElementById('manualAppId').value.trim();
                    this.sessionId = document.getElementById('manualChannelId').value.trim();
                    this.userId = document.getElementById('manualUserId').value.trim();
                    this.token = document.getElementById('manualToken').value.trim();
                    this.mode = document.getElementById('manualMode').value;
                    
                    // éªŒè¯å‚æ•° - è¯¦ç»†æ£€æŸ¥æ¯ä¸ªå¿…å¡«å‚æ•°
                    if (!this.appId || this.appId === '') {
                        throw new Error('è¯·è¾“å…¥AppIDï¼ˆåº”ç”¨æ ‡è¯†ï¼‰');
                    }
                    if (!this.sessionId || this.sessionId === '') {
                        throw new Error('è¯·è¾“å…¥é¢‘é“IDï¼ˆæˆ¿é—´IDï¼‰');
                    }
                    if (!this.userId || this.userId === '') {
                        throw new Error('è¯·è¾“å…¥ç”¨æˆ·ID');
                    }
                    if (!this.token || this.token === '') {
                        throw new Error('è¯·è¾“å…¥Tokenï¼ˆè®¿é—®ä»¤ç‰Œï¼‰');
                    }
                    
                    // éªŒè¯AppIDæ ¼å¼ï¼ˆåªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ï¼‰
                    if (!/^[a-zA-Z0-9_]+$/.test(this.appId)) {
                        throw new Error('AppIDæ ¼å¼æ— æ•ˆï¼Œåªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿');
                    }
                    
                    // éªŒè¯é¢‘é“IDæ ¼å¼ï¼ˆåªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ã€è¿å­—ç¬¦ï¼‰
                    if (!/^[a-zA-Z0-9_-]+$/.test(this.sessionId)) {
                        throw new Error('é¢‘é“IDæ ¼å¼æ— æ•ˆï¼Œåªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ã€è¿å­—ç¬¦');
                    }
                    
                    // éªŒè¯ç”¨æˆ·IDæ ¼å¼ï¼ˆåªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ã€è¿å­—ç¬¦ï¼‰
                    if (!/^[a-zA-Z0-9_-]+$/.test(this.userId)) {
                        throw new Error('ç”¨æˆ·IDæ ¼å¼æ— æ•ˆï¼Œåªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ã€è¿å­—ç¬¦');
                    }
                    
                    // éªŒè¯é•¿åº¦
                    if (this.sessionId.length > 64) {
                        throw new Error('é¢‘é“IDé•¿åº¦ä¸èƒ½è¶…è¿‡64ä¸ªå­—ç¬¦');
                    }
                    if (this.userId.length > 64) {
                        throw new Error('ç”¨æˆ·IDé•¿åº¦ä¸èƒ½è¶…è¿‡64ä¸ªå­—ç¬¦');
                    }
                    
                    console.log('æ‰‹åŠ¨è¾“å…¥çš„å‚æ•°éªŒè¯é€šè¿‡:', {
                        appId: this.appId,
                        sessionId: this.sessionId,
                        userId: this.userId,
                        mode: this.mode,
                        tokenLength: this.token.length
                    });
                    
                    // éšè—è¾“å…¥ç•Œé¢
                    document.getElementById('waitingScreen').innerHTML = '<div class="loading-spinner"></div><h2>æ­£åœ¨è¿æ¥...</h2>';
                    
                    // å¼€å§‹åˆå§‹åŒ–RTC
                    await this.initRTC();
                    
                } catch (error) {
                    console.error('æ‰‹åŠ¨åŠ å…¥å¤±è´¥:', error);
                    this.showError(error.message);
                }
            }
            
            async initRTC() {
                try {
                    console.log('å¼€å§‹åˆå§‹åŒ–RTC...');
                    
                    // ç­‰å¾…SDKåŠ è½½å®Œæˆ
                    await loadSDKWithRetry();
                    
                    // æ£€æŸ¥SDKæ˜¯å¦æ­£ç¡®åŠ è½½ï¼ˆæŒ‰ç…§å®˜æ–¹ç¤ºä¾‹ï¼‰
                    if (typeof DingRTC === 'undefined' || !DingRTC.default) {
                        throw new Error('SDKåŠ è½½å¤±è´¥ï¼Œæœªèƒ½æ‰¾åˆ°DingRTCå¯¹è±¡');
                    }
                    
                    // ä½¿ç”¨å®˜æ–¹æ ‡å‡†æ–¹å¼
                    const RtcEngine = DingRTC.default;
                    console.log('RtcEngineç±»å‹:', typeof RtcEngine);
                    
                    // æ£€æŸ¥ç³»ç»Ÿæ”¯æŒï¼ˆæŒ‰ç…§å®˜æ–¹ç¤ºä¾‹ï¼‰
                    if (!RtcEngine.checkSystemRequirements()) {
                        throw new Error('å½“å‰ç¯å¢ƒä¸æ”¯æŒRTCé€šä¿¡ï¼Œè¯·æ£€æŸ¥URLåè®®æ˜¯å¦ä¸ºhttpsæˆ–ä½¿ç”¨æœ€æ–°ç‰ˆChromeæµè§ˆå™¨');
                    }
                    
                    // åˆ›å»ºRTCå®¢æˆ·ç«¯ï¼ˆæŒ‰ç…§å®˜æ–¹ç¤ºä¾‹ï¼‰
                    console.log('åˆ›å»ºRTCå®¢æˆ·ç«¯...');
                    this.mediaEngine = RtcEngine.createClient();
                    console.log('RTCå®¢æˆ·ç«¯åˆ›å»ºæˆåŠŸ');
                    
                    // åˆ›å»ºtrackslï¼ˆæŒ‰ç…§å®˜æ–¹ç¤ºä¾‹ï¼‰
                    if (this.mode === 'video') {
                        console.log('åˆ›å»ºéŸ³è§†é¢‘tracks...');
                        const tracks = await RtcEngine.createMicrophoneAndCameraTracks(
                            { dimension: 'VD_640x480', frameRate: 15 }, 
                            {}
                        );
                        this.cameraTrack = tracks[0];
                        this.micTrack = tracks[1];
                        console.log('éŸ³è§†é¢‘tracksåˆ›å»ºæˆåŠŸ');
                    } else {
                        console.log('åˆ›å»ºéŸ³é¢‘track...');
                        this.micTrack = await RtcEngine.createMicrophoneAudioTrack();
                        console.log('éŸ³é¢‘trackåˆ›å»ºæˆåŠŸ');
                    }
                    
                    console.log('RTCå¼•æ“åˆå§‹åŒ–æˆåŠŸ');
                    await this.joinSession();
                    
                } catch (error) {
                    console.error('RTCåˆå§‹åŒ–é”™è¯¯:', error);
                    this.showError('åˆå§‹åŒ–å¤±è´¥: ' + error.message);
                }
            }
            

            initEvents() {
                console.log('=== å¼€å§‹è®¾ç½®äº‹ä»¶ç›‘å¬ ===');
                
                // ğŸ“Œ æŒ‰ç…§å®˜æ–¹ç¤ºä¾‹è®¾ç½®äº‹ä»¶ç›‘å¬ï¼ˆæ­£ç¡®çš„é¡ºåºå’Œé€»è¾‘ï¼‰
                this.mediaEngine.on('user-joined', (user) => {
                    console.log('ğŸ”¥ [EVENT] user-joined è§¦å‘!', user);
                    console.log('ç”¨æˆ·ä¿¡æ¯:', {
                        uid: user.uid,
                        userId: user.userId, 
                        userName: user.userName
                    });
                    
                    // æ›´æ–°ç”¨æˆ·åˆ—è¡¨
                    this.updateUserList();
                    
                    // âœ… ç«‹å³æ›´æ–°è¿æ¥çŠ¶æ€ä¸º"å·²è¿æ¥"
                    const displayName = user.userName || user.uid || user.userId;
                    document.getElementById('connectionStatus').textContent = `å·²è¿æ¥: ${displayName}`;
                    console.log('âœ… çŠ¶æ€æ›´æ–°ä¸º: å·²è¿æ¥ -', displayName);
                });
                
                this.mediaEngine.on('user-published', (user, mediaType, auxiliary) => {
                    console.log('ğŸ”¥ [EVENT] user-published è§¦å‘!', {
                        user: user.userName || user.uid,
                        mediaType,
                        auxiliary
                    });
                    
                    if (mediaType === 'video') {
                        // ç«‹å³è®¢é˜…è¿œç¨‹è§†é¢‘
                        this.mediaEngine.subscribe(user.userId, 'video', auxiliary).then((track) => {
                            const remoteVideoEl = document.getElementById('remoteVideo');
                            track.play(remoteVideoEl);
                            console.log('âœ… è¿œç¨‹è§†é¢‘è®¢é˜…æˆåŠŸ');
                            
                            // æ›´æ–°è¿æ¥çŠ¶æ€ä¸ºé€šè¯ä¸­
                            document.getElementById('connectionStatus').textContent = 'é€šè¯ä¸­...';
                            console.log('âœ… çŠ¶æ€æ›´æ–°ä¸º: é€šè¯ä¸­');
                        }).catch(error => {
                            console.error('è¿œç¨‹è§†é¢‘è®¢é˜…å¤±è´¥:', error);
                        });
                    }
                });
                
                this.mediaEngine.on('user-unpublished', (user, mediaType, auxiliary) => {
                    console.log('ğŸ”¥ [EVENT] user-unpublished è§¦å‘!', {
                        user: user.userName || user.uid,
                        mediaType
                    });
                    
                    if (mediaType === 'video') {
                        const remoteVideoEl = document.getElementById('remoteVideo');
                        if (remoteVideoEl) {
                            remoteVideoEl.srcObject = null;
                        }
                        // è§†é¢‘åœæ­¢åï¼Œå¦‚æœè¿˜æœ‰ç”¨æˆ·åœ¨çº¿ï¼ŒçŠ¶æ€ä¸ºå·²è¿æ¥ï¼Œå¦åˆ™ä¸ºç­‰å¾…
                        const currentRemoteUsers = this.mediaEngine.remoteUsers;
                        if (currentRemoteUsers.length > 0) {
                            const displayName = currentRemoteUsers[0].userName || currentRemoteUsers[0].uid;
                            document.getElementById('connectionStatus').textContent = `å·²è¿æ¥: ${displayName}`;
                        } else {
                            document.getElementById('connectionStatus').textContent = 'ç­‰å¾…å¯¹æ–¹åŠ å…¥...';
                        }
                    }
                });
                
                this.mediaEngine.on('user-left', (user) => {
                    console.log('ğŸ”¥ [EVENT] user-left è§¦å‘!', user);
                    
                    // æ›´æ–°ç”¨æˆ·åˆ—è¡¨
                    this.updateUserList();
                    
                    // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å…¶ä»–ç”¨æˆ·
                    const remainingUsers = this.mediaEngine.remoteUsers;
                    if (remainingUsers.length > 0) {
                        const displayName = remainingUsers[0].userName || remainingUsers[0].uid;
                        document.getElementById('connectionStatus').textContent = `å·²è¿æ¥: ${displayName}`;
                        console.log('âœ… è¿˜æœ‰å…¶ä»–ç”¨æˆ·ï¼ŒçŠ¶æ€:', `å·²è¿æ¥: ${displayName}`);
                    } else {
                        document.getElementById('connectionStatus').textContent = 'ç­‰å¾…å¯¹æ–¹åŠ å…¥...';
                        console.log('âœ… æ²¡æœ‰å…¶ä»–ç”¨æˆ·ï¼ŒçŠ¶æ€: ç­‰å¾…å¯¹æ–¹åŠ å…¥');
                        
                        // æ¸…ç©ºè¿œç¨‹è§†é¢‘
                        const remoteVideoEl = document.getElementById('remoteVideo');
                        if (remoteVideoEl) {
                            remoteVideoEl.srcObject = null;
                        }
                    }
                });
                
                // ä½¿ç”¨æ­£ç¡®çš„äº‹ä»¶åï¼ˆå¸¦è¿å­—ç¬¦ï¼‰
                this.mediaEngine.on('connection-state-changed', (current, prev, reason) => {
                    console.log('ğŸ”¥ [EVENT] connection-state-changed è§¦å‘!', {
                        current,
                        prev, 
                        reason
                    });
                    
                    if (current === 'disconnected') {
                        document.getElementById('connectionStatus').textContent = 'è¿æ¥æ–­å¼€';
                        if (reason !== 'leave') {
                            this.showError('è¿æ¥å·²æ–­å¼€');
                        }
                    } else if (current === 'connected') {
                        console.log('âœ… RTCè¿æ¥å·²å»ºç«‹');
                        // ä¸è¦åœ¨è¿™é‡Œè®¾ç½®çŠ¶æ€ï¼Œç­‰å¾…user-joinedäº‹ä»¶
                    }
                });
                
                console.log('=== äº‹ä»¶ç›‘å¬è®¾ç½®å®Œæˆ ===');
            }
            
            updateUserList() {
                // æ›´æ–°è¿œç¨‹ç”¨æˆ·åˆ—è¡¨
                console.log('\n=== updateUserList è¢«è°ƒç”¨ ===');
                console.log('å½“å‰è¿œç¨‹ç”¨æˆ·æ•°é‡:', this.mediaEngine.remoteUsers.length);
                console.log('å®Œæ•´çš„remoteUserså¯¹è±¡:', this.mediaEngine.remoteUsers);
                
                this.mediaEngine.remoteUsers.forEach((user, index) => {
                    console.log(`è¿œç¨‹ç”¨æˆ· ${index + 1}:`, {
                        uid: user.uid,
                        userId: user.userId,
                        userName: user.userName,
                        hasVideo: user.hasVideo,
                        hasAudio: user.hasAudio
                    });
                });
                
                // å¦‚æœæœ‰ç”¨æˆ·ï¼Œæ›´æ–°çŠ¶æ€
                if (this.mediaEngine.remoteUsers.length > 0) {
                    const firstUser = this.mediaEngine.remoteUsers[0];
                    const displayName = firstUser.userName || firstUser.uid || firstUser.userId;
                    console.log('âš¡ è®¾ç½®è¿æ¥çŠ¶æ€ä¸º:', `å·²è¿æ¥: ${displayName}`);
                    document.getElementById('connectionStatus').textContent = `å·²è¿æ¥: ${displayName}`;
                } else {
                    console.log('âš¡ è®¾ç½®è¿æ¥çŠ¶æ€ä¸º: ç­‰å¾…å¯¹æ–¹åŠ å…¥...');
                    document.getElementById('connectionStatus').textContent = 'ç­‰å¾…å¯¹æ–¹åŠ å…¥...';
                }
                console.log('=== updateUserList ç»“æŸ ===\n');
            }
            
            async joinSession() {
                try {
                    console.log('å¼€å§‹åŠ å…¥ä¼šè¯...');
                    
                    // ğŸ“Œ CRITICAL: å¿…é¡»åœ¨joinä¹‹å‰è®¾ç½®äº‹ä»¶ç›‘å¬ï¼ˆæŒ‰ç…§å®˜æ–¹ç¤ºä¾‹ï¼‰
                    this.initEvents();
                    console.log('äº‹ä»¶ç›‘å¬å·²è®¾ç½®ï¼Œå‡†å¤‡åŠ å…¥æˆ¿é—´...');
                    
                    // æœ¬åœ°æ‘„åƒå¤´é¢„è§ˆï¼ˆæŒ‰ç…§å®˜æ–¹ç¤ºä¾‹ï¼‰
                    if (this.mode === 'video' && this.cameraTrack) {
                        const localVideoEl = document.getElementById('localVideo');
                        this.cameraTrack.play(localVideoEl);
                        document.getElementById('videoMode').classList.remove('hidden');
                        console.log('æœ¬åœ°è§†é¢‘é¢„è§ˆå¯åŠ¨æˆåŠŸ');
                    } else {
                        document.getElementById('audioMode').classList.remove('hidden');
                    }
                    
                    // æ„å»ºé‰´æƒä¿¡æ¯ï¼ˆæŒ‰ç…§å®˜æ–¹ç¤ºä¾‹æ ¼å¼ï¼‰
                    const authInfo = {
                        appId: this.appId,
                        uid: this.userId,
                        token: this.token,
                        userName: this.userId,
                        channel: this.sessionId
                    };
                    
                    console.log('\n=== åŠ å…¥æˆ¿é—´å‚æ•°æ£€æŸ¥ ===');
                    console.log('é‰´æƒä¿¡æ¯:', {
                        appId: this.appId,
                        uid: this.userId,
                        channel: this.sessionId,
                        tokenLength: this.token.length,
                        userName: this.userId
                    });
                    console.log('\u26a0\ufe0f è¯·ç¡®ä¿å¦ä¸€ä¸ªç”¨æˆ·ä½¿ç”¨ç›¸åŒçš„:');
                    console.log('  - appId:', this.appId);
                    console.log('  - channel:', this.sessionId);
                    console.log('  - ä¸åŒçš„ userId ï¼ˆå½“å‰:', this.userId, '\uff09');
                    console.log('=== å‚æ•°æ£€æŸ¥ç»“æŸ ===\n');
                    
                    // ä½¿ç”¨å®˜æ–¹APIåŠ å…¥æˆ¿é—´ï¼ˆæŒ‰ç…§vanillaVersion.htmlç¤ºä¾‹ï¼‰
                    const result = await this.mediaEngine.join(authInfo);
                    console.log('ğŸ‰ ä¼šè¯åŠ å…¥æˆåŠŸï¼ç»“æœ:', result);
                    
                    // ğŸ“Œ ç«‹å³å‘å¸ƒæœ¬åœ°æµï¼Œè¿™æ ·å…¶ä»–ç”¨æˆ·èƒ½çœ‹åˆ°ä½ ï¼ˆæŒ‰ç…§å®˜æ–¹ç¤ºä¾‹ï¼‰
                    const tracksToPublish = [];
                    if (this.micTrack) tracksToPublish.push(this.micTrack);
                    if (this.cameraTrack) tracksToPublish.push(this.cameraTrack);
                    
                    if (tracksToPublish.length > 0) {
                        await this.mediaEngine.publish(tracksToPublish);
                        console.log('âœ… æœ¬åœ°æµå‘å¸ƒæˆåŠŸï¼Œå…¶ä»–ç”¨æˆ·ç°åœ¨å¯ä»¥çœ‹åˆ°ä½ ');
                    }
                    
                    // ğŸ“Œ è®¢é˜…å·²åœ¨æˆ¿é—´çš„ç”¨æˆ·æµï¼ˆæŒ‰ç…§å®˜æ–¹ç¤ºä¾‹ï¼‰
                    await this.subscribeExistingUsers();
                    
                    // æˆåŠŸåéšè—ç­‰å¾…ç•Œé¢
                    document.getElementById('waitingScreen').classList.add('hidden');
                    
                    // ğŸ“Œ åˆå§‹çŠ¶æ€æ€»æ˜¯"ç­‰å¾…å¯¹æ–¹åŠ å…¥"ï¼Œå› ä¸ºäº‹ä»¶å¯èƒ½è¿˜æœªè§¦å‘
                    document.getElementById('connectionStatus').textContent = 'ç­‰å¾…å¯¹æ–¹åŠ å…¥...';
                    console.log('\nğŸ” æˆ¿é—´åŠ å…¥å®Œæˆï¼Œå½“å‰è¿œç¨‹ç”¨æˆ·æ•°é‡:', this.mediaEngine.remoteUsers.length);
                    
                } catch (error) {
                    console.error('åŠ å…¥ä¼šè¯é”™è¯¯:', error);
                    this.showError('åŠ å…¥ä¼šè¯å¤±è´¥: ' + error.message);
                }
            }
            
            // ğŸ“Œ æ–°å¢æ–¹æ³•ï¼šè®¢é˜…å·²å­˜åœ¨çš„ç”¨æˆ·ï¼ˆæŒ‰ç…§å®˜æ–¹ç¤ºä¾‹ï¼‰
            async subscribeExistingUsers() {
                try {
                    console.log('æ£€æŸ¥å·²å­˜åœ¨çš„ç”¨æˆ·...');
                    const subParams = [{ uid: 'mcu', mediaType: 'audio', auxiliary: false }];
                    
                    // æ£€æŸ¥å·²åœ¨æˆ¿é—´çš„è¿œç¨‹ç”¨æˆ·
                    for (const user of this.mediaEngine.remoteUsers) {
                        console.log('å‘ç°å·²å­˜åœ¨ç”¨æˆ·:', user.userName || user.uid, {
                            hasVideo: user.hasVideo,
                            hasAuxiliary: user.hasAuxiliary
                        });
                        
                        if (user.hasAuxiliary) {
                            subParams.push({ uid: user.userId, mediaType: 'video', auxiliary: true });
                        }
                        if (user.hasVideo) {
                            subParams.push({ uid: user.userId, mediaType: 'video', auxiliary: false });
                        }
                    }
                    
                    if (subParams.length > 1) { // é™¤äº†mcuéŸ³é¢‘ï¼Œè¿˜æœ‰å…¶ä»–æµ
                        console.log('å¼€å§‹æ‰¹é‡è®¢é˜…å·²å­˜åœ¨ç”¨æˆ·çš„æµ...');
                        const batchSubscribeResult = await this.mediaEngine.batchSubscribe(subParams);
                        
                        for (const { error, track, uid, auxiliary } of batchSubscribeResult) {
                            if (error) {
                                console.error(`è®¢é˜…${uid} ${auxiliary ? 'screenShare' : 'camera'} å¤±è´¥:`, error.message);
                                continue;
                            }
                            
                            if (track.trackMediaType === 'audio') {
                                track.play();
                                console.log('âœ… éŸ³é¢‘åˆæµè®¢é˜…æˆåŠŸ');
                            } else {
                                const remoteVideoEl = document.getElementById('remoteVideo');
                                track.play(remoteVideoEl);
                                console.log(`âœ… è¿œç¨‹è§†é¢‘${uid}è®¢é˜…æˆåŠŸ`);
                                // æ›´æ–°è¿æ¥çŠ¶æ€
                                document.getElementById('connectionStatus').textContent = 'é€šè¯ä¸­...';
                            }
                        }
                    } else {
                        console.log('æš‚æ— å…¶ä»–ç”¨æˆ·æµéœ€è¦è®¢é˜…');
                        // ä»…è®¢é˜…éŸ³é¢‘åˆæµ
                        try {
                            const audioTrack = await this.mediaEngine.subscribe('mcu', 'audio', false);
                            audioTrack.play();
                            console.log('âœ… éŸ³é¢‘åˆæµè®¢é˜…æˆåŠŸ');
                        } catch (error) {
                            console.warn('éŸ³é¢‘åˆæµè®¢é˜…å¤±è´¥:', error);
                        }
                    }
                } catch (error) {
                    console.error('è®¢é˜…å·²å­˜åœ¨ç”¨æˆ·å¤±è´¥:', error);
                }
            }
            
            showError(message) {
                document.getElementById('errorMessage').textContent = message;
                document.getElementById('errorScreen').classList.remove('hidden');
                document.getElementById('waitingScreen').classList.add('hidden');
            }
            
            // æ ‡å‡†åŒ–é¢‘é“IDæ ¼å¼
            normalizeChannelId(channelId) {
                if (!channelId) return null;
                
                // ç§»é™¤æ— æ•ˆå­—ç¬¦ï¼Œåªä¿ç•™å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ã€è¿å­—ç¬¦
                let normalized = channelId.replace(/[^a-zA-Z0-9_-]/g, '_');
                
                // ç¡®ä¿é•¿åº¦åœ¨æœ‰æ•ˆèŒƒå›´å†…ï¼ˆ1-64å­—ç¬¦ï¼‰
                if (normalized.length > 64) {
                    normalized = normalized.substring(0, 64);
                }
                
                // ç¡®ä¿ä¸ä¸ºç©º
                if (normalized.length === 0) {
                    normalized = 'channel_' + Date.now();
                }
                
                return normalized;
            }
            
            // éªŒè¯é¢‘é“IDæ ¼å¼
            validateChannelId(channelId) {
                if (!channelId || typeof channelId !== 'string') {
                    console.error('é¢‘é“IDä¸ºç©ºæˆ–æ ¼å¼é”™è¯¯');
                    return false;
                }
                
                // æ£€æŸ¥é•¿åº¦
                if (channelId.length < 1 || channelId.length > 64) {
                    console.error('é¢‘é“IDé•¿åº¦æ— æ•ˆ:', channelId.length);
                    return false;
                }
                
                // æ£€æŸ¥å­—ç¬¦
                if (!/^[a-zA-Z0-9_-]+$/.test(channelId)) {
                    console.error('é¢‘é“IDåŒ…å«æ— æ•ˆå­—ç¬¦:', channelId);
                    return false;
                }
                
                return true;
            }
            
            // ç”Ÿæˆç®€å•çš„ä¸´æ—¶tokenç”¨äºæµ‹è¯•ç¯å¢ƒ
            generateTempToken() {
                // æ³¨æ„ï¼šè¿™åªæ˜¯ä¸€ä¸ªç®€å•çš„æµ‹è¯•tokenï¼Œç”Ÿäº§ç¯å¢ƒä¸å¯ä½¿ç”¨
                // ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨æœåŠ¡å™¨ç”Ÿæˆçš„æœ‰æ•ˆtoken
                const timestamp = Math.floor(Date.now() / 1000);
                const expireTime = timestamp + 3600; // 1å°æ—¶åè¿‡æœŸ
                
                // ä½¿ç”¨ç®€å•çš„base64ç¼–ç æ¥æ¨¡æ‹Ÿtokenæ ¼å¼
                const tokenData = {
                    appId: this.appId,
                    channelId: this.sessionId,
                    userId: this.userId,
                    expireTime: expireTime
                };
                
                try {
                    return btoa(JSON.stringify(tokenData));
                } catch (error) {
                    console.warn('ç”Ÿæˆä¸´æ—¶tokenå¤±è´¥:', error);
                    return 'temp_token_' + timestamp;
                }
            }
        }
        
        let player;
        
        // æµ‹è¯•é¢æ¿åŠŸèƒ½
        function showTestPanel() {
            document.getElementById('testPanel').classList.remove('hidden');
            initTestPanel();
        }
        
        function closeTestPanel() {
            document.getElementById('testPanel').classList.add('hidden');
        }
        
        function initTestPanel() {
            checkSDKStatus();
            parseCurrentParams();
            checkConfigStatus();
            
            // è®¾ç½®æ§åˆ¶å°æ—¥å¿—æ‹¦æˆª
            const originalLog = console.log;
            const originalWarn = console.warn;
            const originalError = console.error;
            
            const testConsole = document.getElementById('testConsole');
            
            function addToTestConsole(level, message) {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.style.color = level === 'error' ? '#ff6b6b' : level === 'warn' ? '#ffa726' : '#4fc3f7';
                logEntry.textContent = `[${timestamp}] ${level.toUpperCase()}: ${message}`;
                testConsole.appendChild(logEntry);
                testConsole.scrollTop = testConsole.scrollHeight;
            }
            
            console.log = function(...args) {
                originalLog.apply(console, args);
                addToTestConsole('info', args.join(' '));
            };
            
            console.warn = function(...args) {
                originalWarn.apply(console, args);
                addToTestConsole('warn', args.join(' '));
            };
            
            console.error = function(...args) {
                originalError.apply(console, args);
                addToTestConsole('error', args.join(' '));
            };
        }
        
        function checkSDKStatus() {
            const statusEl = document.getElementById('testSdkStatus');
            
            if (typeof DingRTC !== 'undefined' && DingRTC.default) {
                statusEl.innerHTML = `âœ… SDKåŠ è½½æˆåŠŸ<br>ç‰ˆæœ¬: ${DingRTC.VERSION || 'æœªçŸ¥'}<br>ç±»å‹: ${typeof DingRTC}`;
                statusEl.style.background = 'rgba(76, 175, 80, 0.3)';
            } else {
                statusEl.innerHTML = 'âŒ SDKæœªåŠ è½½';
                statusEl.style.background = 'rgba(244, 67, 54, 0.3)';
            }
        }
        
        function parseCurrentParams() {
            const statusEl = document.getElementById('testParamsStatus');
            
            try {
                const urlParams = new URLSearchParams(window.location.search);
                
                const theme = urlParams.get('theme');
                const lang = urlParams.get('lang');
                const source = urlParams.get('source');
                const ref = urlParams.get('ref');
                const token = urlParams.get('token');
                
                if (theme && lang && source && ref) {
                    const roomId = atob(theme) + atob(lang);
                    const userId = atob(source) + atob(ref);
                    
                    statusEl.innerHTML = `âœ… å‚æ•°è§£ææˆåŠŸ<br>
                        æˆ¿é—´ID: ${roomId}<br>
                        ç”¨æˆ·ID: ${userId}<br>
                        Token: ${token ? 'âœ… å·²æä¾›' : 'âŒ æœªæä¾›'}<br>
                        æ¨¡å¼: ${urlParams.get('debug') === 'false' ? 'è§†é¢‘' : 'éŸ³é¢‘'}`;
                    statusEl.style.background = 'rgba(76, 175, 80, 0.3)';
                } else {
                    statusEl.innerHTML = 'âŒ ç¼ºå°‘å¿…è¦å‚æ•° (theme, lang, source, ref)';
                    statusEl.style.background = 'rgba(244, 67, 54, 0.3)';
                }
            } catch (error) {
                statusEl.innerHTML = `âŒ è§£æå¤±è´¥: ${error.message}`;
                statusEl.style.background = 'rgba(244, 67, 54, 0.3)';
            }
        }
        
        async function checkConfigStatus() {
            const statusEl = document.getElementById('testConfigStatus');
            
            try {
                const appId = await window.ALIYUN_CONFIG.getAppId();
                const token = window.ALIYUN_CONFIG.getToken();
                
                statusEl.innerHTML = `
                    AppID: ${appId ? 'âœ… å·²é…ç½®' : 'âŒ æœªé…ç½®'}<br>
                    Token: ${token ? 'âœ… å·²é…ç½®' : 'âŒ æœªé…ç½®'}<br>
                    æœ¬åœ°å­˜å‚¨: ${localStorage.getItem('media_app_id') ? 'âœ… æ­£å¸¸' : 'âŒ æ— æ•°æ®'}`;
                
                if (appId && token) {
                    statusEl.style.background = 'rgba(76, 175, 80, 0.3)';
                } else {
                    statusEl.style.background = 'rgba(255, 152, 0, 0.3)';
                }
            } catch (error) {
                statusEl.innerHTML = `âŒ æ£€æŸ¥å¤±è´¥: ${error.message}`;
                statusEl.style.background = 'rgba(244, 67, 54, 0.3)';
            }
        }
        
        function clearTestConsole() {
            document.getElementById('testConsole').innerHTML = 'æ—¥å¿—å·²æ¸…ç©º...';
        }
        
        window.onload = async () => {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œæ‰‹åŠ¨è¾“å…¥æ¨¡å¼...');
            
            try {
                // é¦–å…ˆåŠ è½½SDK
                console.log('å¼€å§‹åŠ è½½SDK...');
                await loadSDKWithRetry();
                
                console.log('SDKåŠ è½½æˆåŠŸï¼Œåˆ›å»ºåº”ç”¨å®ä¾‹...');
                // ç„¶ååˆ›å»ºåº”ç”¨å®ä¾‹
                player = new MediaPlayer();
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                
                // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                const errorEl = document.getElementById('errorMessage');
                const detailsEl = document.getElementById('errorDetails');
                
                errorEl.textContent = 'SDKåŠ è½½å¤±è´¥';
                detailsEl.innerHTML = `
                    <div style="text-align: left; margin-top: 10px;">
                        <strong>é”™è¯¯è¯¦æƒ…:</strong> ${error.message}<br><br>
                        
                        <strong>å¯èƒ½çš„è§£å†³æ–¹æ¡ˆ:</strong><br>
                        1. æ£€æŸ¥ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸<br>
                        2. å°è¯•åˆ·æ–°é¡µé¢<br>
                        3. ä½¿ç”¨Chromeæˆ–Firefoxæµè§ˆå™¨<br>
                        4. æ£€æŸ¥é˜²ç«å¢™è®¾ç½®
                    </div>
                `;
                
                document.getElementById('errorScreen').classList.remove('hidden');
                document.getElementById('waitingScreen').classList.add('hidden');
            }
        };
        
        // æ‰‹åŠ¨åŠ å…¥ä¼šè¯ - å…¨å±€å‡½æ•°ï¼ˆæ­£ç¡®çš„ä½ç½®ï¼‰
        function manualJoinSession() {
            console.log('ğŸ”„ å…¨å±€manualJoinSessionè¢«è°ƒç”¨');
            if (player) {
                console.log('âœ… playerå®ä¾‹å­˜åœ¨ï¼Œè°ƒç”¨player.manualJoinSession()');
                player.manualJoinSession();
            } else {
                console.error('âŒ MediaPlayerå®ä¾‹ä¸å­˜åœ¨ï¼Œè¯·ç­‰å¾…åˆå§‹åŒ–å®Œæˆ');
                alert('ç³»ç»Ÿè¿˜åœ¨åˆå§‹åŒ–ä¸­ï¼Œè¯·ç¨åå†è¯•');
            }
        }
        
        // ä¿å­˜æ‰‹åŠ¨è¾“å…¥çš„è®¾ç½®
        function saveManualInputs() {
            try {
                const settings = {
                    appId: document.getElementById('manualAppId').value.trim(),
                    channelId: document.getElementById('manualChannelId').value.trim(),
                    userId: document.getElementById('manualUserId').value.trim(),
                    token: document.getElementById('manualToken').value.trim(),
                    mode: document.getElementById('manualMode').value
                };
                
                localStorage.setItem('manual_rtc_settings', JSON.stringify(settings));
                alert('è®¾ç½®å·²ä¿å­˜ï¼');
            } catch (error) {
                alert('ä¿å­˜å¤±è´¥: ' + error.message);
            }
        }
        
        // åŠ è½½ä¿å­˜çš„è®¾ç½®
        function loadSavedInputs() {
            try {
                const saved = localStorage.getItem('manual_rtc_settings');
                if (saved) {
                    const settings = JSON.parse(saved);
                    document.getElementById('manualAppId').value = settings.appId || '';
                    document.getElementById('manualChannelId').value = settings.channelId || '';
                    document.getElementById('manualUserId').value = settings.userId || '';
                    document.getElementById('manualToken').value = settings.token || '';
                    document.getElementById('manualMode').value = settings.mode || 'video';
                    alert('è®¾ç½®å·²åŠ è½½ï¼');
                } else {
                    alert('æ²¡æœ‰ä¿å­˜çš„è®¾ç½®');
                }
            } catch (error) {
                alert('åŠ è½½å¤±è´¥: ' + error.message);
            }
        }
        
        // æ§åˆ¶æŒ‰é’®äº‹ä»¶
        document.getElementById('muteBtn').onclick = () => {
            if (player && player.micTrack) {
                const btn = document.getElementById('muteBtn');
                if (player.micTrack.enabled) {
                    player.micTrack.setEnabled(false);
                    btn.textContent = 'ğŸ”‡';
                    btn.style.background = '#e74c3c';
                } else {
                    player.micTrack.setEnabled(true);
                    btn.textContent = 'ğŸ¤';
                    btn.style.background = 'rgba(255,255,255,0.15)';
                }
            }
        };
        
        document.getElementById('videoBtn').onclick = () => {
            if (player && player.cameraTrack) {
                const btn = document.getElementById('videoBtn');
                if (player.cameraTrack.enabled) {
                    player.cameraTrack.setEnabled(false);
                    btn.textContent = 'ğŸ“¹';
                    btn.style.background = '#e74c3c';
                } else {
                    player.cameraTrack.setEnabled(true);
                    btn.textContent = 'ğŸ“¹';
                    btn.style.background = 'rgba(255,255,255,0.15)';
                }
            }
        };
        
        document.getElementById('hangupBtn').onclick = async () => {
            if (player && player.mediaEngine) {
                // æ¸…ç†æœ¬åœ°æµ
                if (player.cameraTrack) {
                    player.cameraTrack.stop();
                    player.cameraTrack.close();
                }
                if (player.micTrack) {
                    player.micTrack.stop();
                    player.micTrack.close();
                }
                
                // ç¦»å¼€æˆ¿é—´
                await player.mediaEngine.leave();
            }
            
            // å…³é—­çª—å£æˆ–è¿”å›ä¸Šä¸€é¡µ
            if (window.history.length > 1) {
                window.history.back();
            } else {
                window.close();
            }
        };
    </script>
</body>
</html>