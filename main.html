<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é˜¿é‡Œäº‘RTCé€šè¯</title>
    <script>
        // æŒ‰ç…§å®˜æ–¹ç¤ºä¾‹ä½¿ç”¨æ­£ç¡®çš„SDKé“¾æ¥
        function loadSDK() {
            const script = document.createElement('script');
            // ä½¿ç”¨å®˜æ–¹ç¤ºä¾‹ä¸­çš„SDKé“¾æ¥
            script.src = 'https://dingrtc.oss-cn-zhangjiakou.aliyuncs.com/sdk/web/index.umd.3.6.0.js';
            
            script.onload = function() {
                console.log('âœ… å®˜æ–¹SDKåŠ è½½æˆåŠŸ');
                // æ£€æŸ¥DingRTCå¯¹è±¡
                if (typeof DingRTC !== 'undefined') {
                    console.log('âœ… DingRTCå¯¹è±¡å¯ç”¨:', typeof DingRTC);
                    window.rtcManager = new RTCManager();
                } else {
                    console.error('âŒ DingRTCå¯¹è±¡ä¸å¯ç”¨');
                    showSDKError();
                }
            };
            
            script.onerror = function() {
                console.error('âŒ å®˜æ–¹SDKåŠ è½½å¤±è´¥');
                showSDKError();
            };
            
            document.head.appendChild(script);
        }
        
        function showSDKError() {
            document.getElementById('statusDisplay').textContent = 'SDKåŠ è½½å¤±è´¥';
            const errorMsg = 'æ— æ³•åŠ è½½é˜¿é‡Œäº‘RTC SDKï¼\n\nè¯·æ£€æŸ¥ï¼š\n1. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸\n2. é˜²ç«å¢™æˆ–ä»£ç†è®¾ç½®\n3. å°è¯•åˆ·æ–°é¡µé¢';
            alert(errorMsg);
        }
        
        // é¡µé¢åŠ è½½å®ŒæˆååŠ è½½SDK
        document.addEventListener('DOMContentLoaded', loadSDK);
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh; overflow: hidden; color: white;
        }
        
        .app-container { height: 100vh; display: flex; flex-direction: column; }
        
        /* é€šè¯ç•Œé¢ */
        .call-interface { flex: 1; position: relative; }
        .video-container { position: relative; width: 100%; height: 100%; }
        .remote-video { width: 100%; height: 100%; object-fit: cover; background: #000; }
        .local-video {
            position: absolute; top: 20px; right: 20px; width: 150px; height: 200px;
            border: 2px solid rgba(255,255,255,0.5); border-radius: 12px;
            object-fit: cover; background: #333;
        }
        
        /* ç­‰å¾…ç•Œé¢ */
        .waiting-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8); display: flex; flex-direction: column;
            align-items: center; justify-content: center; text-align: center;
        }
        .waiting-icon { font-size: 80px; margin-bottom: 20px; opacity: 0.7; }
        .waiting-text { font-size: 18px; margin-bottom: 10px; }
        .waiting-detail { font-size: 14px; opacity: 0.8; }
        
        /* æ§åˆ¶æŒ‰é’® */
        .controls {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 20px; padding: 20px; background: rgba(0,0,0,0.5);
            border-radius: 50px; backdrop-filter: blur(10px);
        }
        .control-btn {
            width: 60px; height: 60px; border: none; border-radius: 50%;
            background: rgba(255,255,255,0.2); color: white; font-size: 24px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: all 0.3s ease;
        }
        .control-btn:hover { background: rgba(255,255,255,0.3); transform: scale(1.1); }
        .control-btn.muted { background: #e74c3c; }
        .control-btn.hangup { background: #e74c3c; width: 70px; height: 70px; }
        
        /* çŠ¶æ€æ  */
        .status-bar {
            position: absolute; top: 0; left: 0; right: 0; padding: 20px;
            background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, transparent 100%);
            z-index: 100; display: flex; justify-content: space-between; align-items: center;
        }
        .room-info { font-size: 14px; opacity: 0.9; }
        .connection-status { font-size: 16px; font-weight: bold; }
        
        .hidden { display: none !important; }
        .loading { animation: pulse 1.5s ease-in-out infinite alternate; }
        @keyframes pulse { from { opacity: 0.6; } to { opacity: 1; } }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- é€šè¯ç•Œé¢ -->
        <div id="callInterface" class="call-interface">
            <!-- çŠ¶æ€æ  -->
            <div class="status-bar">
                <div class="room-info">
                    <div id="roomDisplay">æˆ¿é—´: -</div>
                </div>
                <div class="connection-status" id="statusDisplay">åˆå§‹åŒ–ä¸­...</div>
            </div>
            
            <!-- è§†é¢‘å®¹å™¨ -->
            <div class="video-container">
                <video id="remoteVideo" class="remote-video" autoplay playsinline></video>
                <video id="localVideo" class="local-video" autoplay playsinline muted></video>
                
                <!-- ç­‰å¾…å¯¹æ–¹åŠ å…¥ -->
                <div id="waitingOverlay" class="waiting-overlay">
                    <div class="waiting-icon">ğŸ‘¥</div>
                    <div class="waiting-text">ç­‰å¾…å¯¹æ–¹åŠ å…¥</div>
                    <div class="waiting-detail">æˆ¿é—´å·²å‡†å¤‡å°±ç»ªï¼Œç­‰å¾…å…¶ä»–ç”¨æˆ·...</div>
                </div>
            </div>
            
            <!-- æ§åˆ¶æŒ‰é’® -->
            <div class="controls">
                <button id="muteBtn" class="control-btn" title="é™éŸ³">ğŸ¤</button>
                <button id="videoBtn" class="control-btn" title="æ‘„åƒå¤´">ğŸ“¹</button>
                <button id="hangupBtn" class="control-btn hangup" title="æŒ‚æ–­">ğŸ“</button>
            </div>
        </div>
    </div>

    <script>
        class RTCManager {
            constructor() {
                this.client = null;
                this.localTracks = { audio: null, video: null };
                this.isJoined = false;
                this.roomParams = null;
                // ä¸å†åœ¨æ„é€ å‡½æ•°ä¸­ç«‹å³åˆå§‹åŒ–ï¼Œç­‰å¾…SDKåŠ è½½å®Œæˆ
                this.init();
            }
            
            init() {
                console.log('ğŸš€ RTCç®¡ç†å™¨åˆå§‹åŒ–');
                const hasURLParams = this.parseURLParams();
                
                if (hasURLParams) {
                    this.updateStatus('æ­£åœ¨è‡ªåŠ¨è¿æ¥...');
                } else {
                    this.updateStatus('URLå‚æ•°ç¼ºå¤±ï¼Œæ— æ³•è¿æ¥');
                }
                
                this.setupEventListeners();
            }
            
            parseURLParams() {
                const urlParams = new URLSearchParams(window.location.search);
                const roomId = urlParams.get('roomId');
                const userId = urlParams.get('userId');
                const appId = urlParams.get('appId');
                const token = urlParams.get('token');
                const mode = urlParams.get('mode');
                
                console.log('ğŸ“‹ URLå‚æ•°:', { roomId, userId, appId, mode, hasToken: !!token });
                
                // å¼¹å‡ºå¯¹è¯æ¡†æ˜¾ç¤ºè§£æç»“æœ
                const paramInfo = `è§£æçš„URLå‚æ•°:
` +
                    `æˆ¿é—´ID: ${roomId || 'ç¼ºå¤±'}
` +
                    `ç”¨æˆ·ID: ${userId || 'ç¼ºå¤±'}
` +
                    `AppID: ${appId || 'ç¼ºå¤±'}
` +
                    `æ¨¡å¼: ${mode || 'ç¼ºå¤±'}
` +
                    `Token: ${token || 'ç¼ºå¤±'}`;
                
                alert(paramInfo);
                
                if (roomId && userId && appId) {
                    this.roomParams = { roomId, userId, appId, token: token || '' };
                    this.autoJoin();
                    return true; // æœ‰å®Œæ•´çš„URLå‚æ•°
                } else {
                    console.log('âš ï¸ URLå‚æ•°ä¸å®Œæ•´');
                    return false; // æ²¡æœ‰å®Œæ•´çš„URLå‚æ•°
                }
            }
            
            async autoJoin() {
                console.log('ğŸ”„ å¼€å§‹è‡ªåŠ¨åŠ å…¥...');
                
                // ç­‰å¾…2ç§’ç¡®ä¿SDKå®Œå…¨åŠ è½½å¹¶åˆå§‹åŒ–
                setTimeout(() => {
                    if (typeof DingRTC === 'undefined') {
                        console.error('âŒ SDKä»æœªåŠ è½½ï¼Œå–æ¶ˆè¿æ¥');
                        this.updateStatus('SDKåŠ è½½å¤±è´¥ï¼Œæ— æ³•è¿æ¥');
                        return;
                    }
                    this.joinCall();
                }, 2000);
            }
            
            setupEventListeners() {
                document.getElementById('muteBtn').onclick = () => this.toggleMute();
                document.getElementById('videoBtn').onclick = () => this.toggleVideo();
                document.getElementById('hangupBtn').onclick = () => this.hangup();
            }
            
            async joinCall() {
                try {
                    if (!this.roomParams) {
                        alert('æ— æ³•è·å–è¿æ¥å‚æ•°ï¼');
                        return;
                    }
                    
                    const { appId, roomId, userId, token } = this.roomParams;
                    
                    console.log('ğŸ¯ å¼€å§‹åŠ å…¥é€šè¯:', { appId, roomId, userId, hasToken: !!token });
                    
                    this.updateStatus('æ­£åœ¨åˆå§‹åŒ–...');
                    
                    // æŒ‰ç…§é¡¹ç›®è§„èŒƒç›´æ¥ä½¿ç”¨DingRTC
                    console.log('ğŸ” æ£€æŸ¥DingRTC SDK:', typeof DingRTC);
                    
                    if (!DingRTC) {
                        throw new Error('é˜¿é‡Œäº‘RTC SDKæœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                    }
                    
                    if (!DingRTC.createClient) {
                        throw new Error('DingRTC.createClient æ–¹æ³•ä¸å­˜åœ¨');
                    }
                    
                    console.log('âœ… DingRTC SDKå¯ç”¨');
                    
                    // æŒ‰ç…§é¡¹ç›®è§„èŒƒç›´æ¥ä½¿ç”¨DingRTC.createClient()
                    try {
                        this.client = DingRTC.createClient();
                        console.log('âœ… å®¢æˆ·ç«¯åˆ›å»ºæˆåŠŸ');
                    } catch (error) {
                        console.error('âŒ å®¢æˆ·ç«¯åˆ›å»ºå¤±è´¥:', error);
                        throw new Error('è¯·ä½¿ç”¨å®˜ç½‘æœ€æ–°Web SDKæ–‡ä»¶');
                    }
                    
                    this.setupRTCEvents();
                    
                    // åˆ›å»ºæœ¬åœ°æµ
                    this.updateStatus('æ­£åœ¨è·å–æ‘„åƒå¤´å’Œéº¦å…‹é£æƒé™...');
                    await this.createLocalTracks();
                    
                    // åŠ å…¥æˆ¿é—´ï¼ˆæŒ‰ç…§å®˜æ–¹ç¤ºä¾‹å‚æ•°æ ¼å¼ï¼‰
                    this.updateStatus('æ­£åœ¨è¿æ¥æˆ¿é—´...');
                    await this.client.join({
                        appId: appId,
                        token: token,
                        uid: userId,
                        channel: roomId,
                        userName: userId
                    });
                    
                    this.isJoined = true;
                    console.log('âœ… æˆåŠŸåŠ å…¥æˆ¿é—´');
                    
                    // å‘å¸ƒæœ¬åœ°æµ
                    const tracksToPublish = [];
                    if (this.localTracks.audio) tracksToPublish.push(this.localTracks.audio);
                    if (this.localTracks.video) tracksToPublish.push(this.localTracks.video);
                    
                    if (tracksToPublish.length > 0) {
                        await this.client.publish(tracksToPublish);
                        console.log('âœ… æœ¬åœ°æµå‘å¸ƒæˆåŠŸ');
                    }
                    
                    // æ’­æ”¾æœ¬åœ°è§†é¢‘
                    if (this.localTracks.video) {
                        this.localTracks.video.play('localVideo');
                    }
                    
                    // æ˜¾ç¤ºé€šè¯ç•Œé¢ï¼ˆåªåœ¨æ‰‹åŠ¨åŠ å…¥æ—¶ï¼‰
                    if (!this.roomParams) {
                        this.showCallInterface(roomId);
                    } else {
                        // è‡ªåŠ¨è¿æ¥æ—¶åªæ›´æ–°æˆ¿é—´ä¿¡æ¯
                        document.getElementById('roomDisplay').textContent = `æˆ¿é—´: ${roomId}`;
                    }
                    this.updateStatus('ç­‰å¾…å¯¹æ–¹åŠ å…¥...');
                    
                } catch (error) {
                    console.error('âŒ åŠ å…¥é€šè¯å¤±è´¥:', error);
                    alert('åŠ å…¥é€šè¯å¤±è´¥: ' + error.message);
                    this.updateStatus('è¿æ¥å¤±è´¥');
                }
            }
            
            async createLocalTracks() {
                try {
                    // æŒ‰ç…§é¡¹ç›®è§„èŒƒç›´æ¥ä½¿ç”¨DingRTC
                    this.localTracks.audio = await DingRTC.createMicrophoneAudioTrack();
                    this.localTracks.video = await DingRTC.createCameraVideoTrack();
                    console.log('âœ… æœ¬åœ°éŸ³è§†é¢‘æµåˆ›å»ºæˆåŠŸ');
                } catch (error) {
                    console.error('âŒ åˆ›å»ºæœ¬åœ°æµå¤±è´¥:', error);
                    throw new Error('æ— æ³•è·å–æ‘„åƒå¤´æˆ–éº¦å…‹é£æƒé™');
                }
            }
            
            setupRTCEvents() {
                console.log('ğŸ­ è®¾ç½®RTCäº‹ä»¶ç›‘å¬');
                
                this.client.on('user-joined', (user) => {
                    console.log('ğŸ‘¤ ç”¨æˆ·åŠ å…¥:', user.userName || user.uid);
                    this.updateStatus(`å·²è¿æ¥: ${user.userName || user.uid}`);
                });
                
                this.client.on('user-published', async (user, mediaType) => {
                    console.log('ğŸ“¡ ç”¨æˆ·å‘å¸ƒæµ:', user.userName || user.uid, mediaType);
                    
                    try {
                        const track = await this.client.subscribe(user.userId, mediaType);
                        
                        if (mediaType === 'video') {
                            track.play('remoteVideo');
                            this.hideWaiting();
                            this.updateStatus('é€šè¯ä¸­...');
                        } else if (mediaType === 'audio') {
                            track.play();
                        }
                    } catch (error) {
                        console.error('âŒ è®¢é˜…æµå¤±è´¥:', error);
                    }
                });
                
                this.client.on('user-left', (user) => {
                    console.log('ğŸ‘‹ ç”¨æˆ·ç¦»å¼€:', user.userName || user.uid);
                    this.showWaiting();
                    this.updateStatus('ç­‰å¾…å¯¹æ–¹åŠ å…¥...');
                });
                
                this.client.on('error', (error) => {
                    console.error('âŒ RTCé”™è¯¯:', error);
                    alert('é€šè¯å‡ºç°é”™è¯¯: ' + error.message);
                });
            }
            
            showCallInterface(roomId) {
                document.getElementById('roomDisplay').textContent = `æˆ¿é—´: ${roomId}`;
            }
            
            hideWaiting() {
                document.getElementById('waitingOverlay').classList.add('hidden');
            }
            
            showWaiting() {
                document.getElementById('waitingOverlay').classList.remove('hidden');
            }
            
            updateStatus(text) {
                document.getElementById('statusDisplay').textContent = text;
                console.log('ğŸ“± çŠ¶æ€æ›´æ–°:', text);
            }
            
            toggleMute() {
                if (this.localTracks.audio) {
                    const enabled = this.localTracks.audio.enabled;
                    this.localTracks.audio.setEnabled(!enabled);
                    const btn = document.getElementById('muteBtn');
                    btn.textContent = enabled ? 'ğŸ”‡' : 'ğŸ¤';
                    btn.classList.toggle('muted', enabled);
                    console.log('ğŸ¤ éŸ³é¢‘çŠ¶æ€:', !enabled ? 'å¼€å¯' : 'é™éŸ³');
                }
            }
            
            toggleVideo() {
                if (this.localTracks.video) {
                    const enabled = this.localTracks.video.enabled;
                    this.localTracks.video.setEnabled(!enabled);
                    const btn = document.getElementById('videoBtn');
                    btn.textContent = enabled ? 'ğŸ“·' : 'ğŸ“¹';
                    btn.classList.toggle('muted', enabled);
                    console.log('ğŸ“¹ è§†é¢‘çŠ¶æ€:', !enabled ? 'å¼€å¯' : 'å…³é—­');
                }
            }
            
            async hangup() {
                try {
                    console.log('ğŸ“ æŒ‚æ–­é€šè¯');
                    
                    // åœæ­¢æœ¬åœ°æµ
                    if (this.localTracks.audio) {
                        this.localTracks.audio.stop();
                        this.localTracks.audio.close();
                    }
                    if (this.localTracks.video) {
                        this.localTracks.video.stop();
                        this.localTracks.video.close();
                    }
                    
                    // ç¦»å¼€æˆ¿é—´
                    if (this.client && this.isJoined) {
                        await this.client.leave();
                    }
                    
                    // è¿”å›è¾“å…¥ç•Œé¢æˆ–å…³é—­é¡µé¢
                    if (this.roomParams) {
                        window.close();
                    } else {
                        location.reload();
                    }
                    
                } catch (error) {
                    console.error('âŒ æŒ‚æ–­å¤±è´¥:', error);
                    window.close();
                }
            }
        }
        
        // é¡µé¢å…³é—­æ—¶æ¸…ç†
        window.addEventListener('beforeunload', () => {
            console.log('ğŸ§¹ é¡µé¢å…³é—­ï¼Œæ¸…ç†èµ„æº');
        });
    </script>
</body>
</html>